<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>WebRTC -- JavaScript 标准参考教程（alpha）</title>
  
  <!-- Included CSS Files (Uncompressed) -->
  <!--
  <link rel="stylesheet" href="stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="/css/foundation.css">
  <link rel="stylesheet" href="/css/main.css">

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script src="/js/jquery.js"></script>
  <script src="/js/toc.js"></script>
  <script src="/js/main.js"></script>

</head>
<body>

<header class="top-bar" id="header">

<div class="fixed">

<nav class="top-bar">
<ul>
<!-- Title Area -->
	<li class="name has-dropdown">
	<h1><a href="/">JavaScript 标准参考教程（alpha） </a></h1>
		<ul class="dropdown">
			
			<li><a href="/#introduction">导论</a></li>
			
			<li><a href="/#grammar">语法</a></li>
			
			<li><a href="/#stdlib">标准库</a></li>
			
			<li><a href="/#oop">面向对象编程</a></li>
			
			<li><a href="/#advanced">语法专题</a></li>
			
			<li><a href="/#dom">DOM模型</a></li>
			
			<li><a href="/#bom">浏览器环境</a></li>
			
			<li><a href="/#htmlapi">Web API</a></li>
			
		</ul>
	</li>
</ul>

<section>


<ul class="left">
<li class="divider"></li>
<li class="has-dropdown"><a class="active" href="#"> 浏览器环境 </a><ul class="dropdown">



<li><a href="/bom/ajax.html">AJAX</a></li>











































<li><a href="/bom/cookie.html">Cookie</a></li>





<li><a href="/bom/cors.html">CORS通信</a></li>





























<li><a href="/bom/engine.html">浏览器环境概述</a></li>

































<li><a href="/bom/history.html">history对象</a></li>













<li><a href="/bom/indexeddb.html">IndexedDB：浏览器端数据库</a></li>























<li><a href="/bom/mobile.html">移动设备API</a></li>

















<li><a href="/bom/notification.html">Web Notifications API</a></li>





























<li><a href="/bom/performance.html">Performance API</a></li>



























<li><a href="/bom/same-origin.html">同源政策</a></li>











































<li class="active"><a href="#">WebRTC</a></li>





<li><a href="/htmlapi/websocket.html">WebSocket</a></li>







<li><a href="/bom/webstorage.html">Web Storage：浏览器端数据储存机制</a></li>







<li><a href="/bom/window.html">window对象</a></li>





</ul></li>
<li class="divider"></li>
<li class="has-dropdown nav-3"><a href="#"> WebRTC</a><ul class="dropdown">
</ul></li>
</ul>


<ul class="right">
	<li class="divider"></li>
	<li>
		<a href="https://github.com/ruanyf/jstutorial" target="_blank">GitHub <i class="foundicon-edit"></i></a>
	</li>
	<li class="divider"></li>
	<li>
		<a href="#">TOP <i class="foundicon-up-arrow"></i></a>
	</li>
</ul>

</section>

</nav>  
</div>
</header>


<article class="bookPage">

  <div class="row">
    <div class="twelve columns">

<h1> WebRTC </h1>

<aside class="right"><p>来自<a href="/">《JavaScript 标准参考教程（alpha）》</a>，by 阮一峰</p></aside>

<div id="toc" class="panel callout radius">目录</div>


<h2 id="概述">概述</h2>

<p>WebRTC是“网络实时通信”（Web Real Time Communication）的缩写。它最初是为了解决浏览器上视频通话而提出的，即两个浏览器之间直接进行视频和音频的通信，不经过服务器。后来发展到除了音频和视频，还可以传输文字和其他数据。</p>

<p>Google是WebRTC的主要支持者和开发者，它最初在Gmail上推出了视频聊天，后来在2011年推出了Hangouts，语序在浏览器中打电话。它推动了WebRTC标准的确立。</p>

<p>WebRTC主要让浏览器具备三个作用。</p>

<ul>
  <li>获取音频和视频</li>
  <li>进行音频和视频通信</li>
  <li>进行任意数据的通信</li>
</ul>

<p>WebRTC共分成三个API，分别对应上面三个作用。</p>

<ul>
  <li>MediaStream （又称getUserMedia）</li>
  <li>RTCPeerConnection</li>
  <li>RTCDataChannel</li>
</ul>

<h2 id="getusermedia">getUserMedia</h2>

<h3 id="概述-1">概述</h3>

<p>navigator.getUserMedia方法目前主要用于，在浏览器中获取音频（通过麦克风）和视频（通过摄像头），将来可以用于获取任意数据流，比如光盘和传感器。</p>

<p>下面的代码用于检查浏览器是否支持getUserMedia方法。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span>  <span class="o">=</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span> <span class="o">||</span>
                          <span class="nb">navigator</span><span class="p">.</span><span class="nx">webkitGetUserMedia</span> <span class="o">||</span>
                          <span class="nb">navigator</span><span class="p">.</span><span class="nx">mozGetUserMedia</span> <span class="o">||</span>
                          <span class="nb">navigator</span><span class="p">.</span><span class="nx">msGetUserMedia</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">)</span> <span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1">// 支持</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="c1">// 不支持</span>
<span class="p">}</span></code></pre></figure>

<p>Chrome 21, Opera 18和Firefox 17，支持该方法。目前，IE还不支持，上面代码中的msGetUserMedia，只是为了确保将来的兼容。</p>

<p>getUserMedia方法接受三个参数。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span>
<span class="err"> </span> <span class="err"> </span> <span class="na">video</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> 
<span class="err"> </span> <span class="err"> </span> <span class="na">audio</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">},</span> <span class="nx">onSuccess</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span></code></pre></figure>

<p>getUserMedia的第一个参数是一个对象，表示要获取哪些多媒体设备，上面的代码表示获取摄像头和麦克风;onSuccess是一个回调函数，在获取多媒体设备成功时调用；onError也是一个回调函数，在取多媒体设备失败时调用。</p>

<p>下面是一个例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="na">video</span><span class="p">:</span> <span class="kc">true</span><span class="p">};</span>

<span class="kd">function</span> <span class="nx">onSuccess</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"video"</span><span class="p">);</span>
  <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"navigator.getUserMedia error: "</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">constraints</span><span class="p">,</span> <span class="nx">onSuccess</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span>

</code></pre></div></div>

<p>如果网页使用了getUserMedia方法，浏览器就会询问用户，是否同意浏览器调用麦克风或摄像头。如果用户同意，就调用回调函数onSuccess；如果用户拒绝，就调用回调函数onError。</p>

<p>onSuccess回调函数的参数是一个数据流对象stream。stream.getAudioTracks方法和stream.getVideoTracks方法，分别返回一个数组，其成员是数据流包含的音轨和视轨（track）。使用的声音源和摄影头的数量，决定音轨和视轨的数量。比如，如果只使用一个摄像头获取视频，且不获取音频，那么视轨的数量为1，音轨的数量为0。每个音轨和视轨，有一个kind属性，表示种类（video或者audio），和一个label属性（比如FaceTime HD Camera (Built-in)）。</p>

<p>onError回调函数接受一个Error对象作为参数。Error对象的code属性有如下取值，说明错误的类型。</p>

<ul>
  <li><strong>PERMISSION_DENIED</strong>：用户拒绝提供信息。</li>
  <li><strong>NOT_SUPPORTED_ERROR</strong>：浏览器不支持硬件设备。</li>
  <li><strong>MANDATORY_UNSATISFIED_ERROR</strong>：无法发现指定的硬件设备。</li>
</ul>

<h3 id="范例获取摄像头">范例：获取摄像头</h3>

<p>下面通过getUserMedia方法，将摄像头拍摄的图像展示在网页上。</p>

<p>首先，需要先在网页上放置一个video元素。图像就展示在这个元素中。</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;video</span> <span class="na">id=</span><span class="s">"webcam"</span><span class="nt">&gt;&lt;/video&gt;</span></code></pre></figure>

<p>然后，用代码获取这个元素。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">onSuccess</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'webcam'</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>接着，将这个元素的src属性绑定数据流，摄影头拍摄的图像就可以显示了。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">onSuccess</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
<span class="err"> </span> <span class="err"> </span> <span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'webcam'</span><span class="p">);</span>
<span class="err"> </span> <span class="err"> </span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nx">video</span><span class="p">.</span><span class="nx">autoplay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
	<span class="c1">// 或者 video.play();</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="na">video</span><span class="p">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">onSuccess</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'webcam'</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">'somevideo.mp4'</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>在Chrome和Opera中，URL.createObjectURL方法将媒体数据流（MediaStream）转为一个二进制对象的URL（Blob URL），该URL可以作为video元素的src属性的值。 在Firefox中，媒体数据流可以直接作为src属性的值。Chrome和Opera还允许getUserMedia获取的音频数据，直接作为audio或者video元素的值，也就是说如果还获取了音频，上面代码播放出来的视频是有声音的。</p>

<p>获取摄像头的主要用途之一，是让用户使用摄影头为自己拍照。Canvas API有一个ctx.drawImage(video, 0, 0)方法，可以将视频的一个帧转为canvas元素。这使得截屏变得非常容易。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;video</span> <span class="na">autoplay</span><span class="nt">&gt;&lt;/video&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">""</span><span class="nt">&gt;</span>
<span class="nt">&lt;canvas</span> <span class="na">style=</span><span class="s">"display:none;"</span><span class="nt">&gt;&lt;/canvas&gt;</span>

<span class="nt">&lt;script&gt;</span>
  <span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'video'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'canvas'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">'2d'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">localMediaStream</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">snapshot</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">localMediaStream</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">video</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="c1">// “image/webp”对Chrome有效，</span>
      <span class="c1">// 其他浏览器自动降为image/png</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'img'</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">(</span><span class="s1">'image/webp'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">video</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">snapshot</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

  <span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="na">video</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
    <span class="nx">localMediaStream</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
  <span class="p">},</span> <span class="nx">errorCallback</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>

</code></pre></div></div>

<h3 id="范例捕获麦克风声音">范例：捕获麦克风声音</h3>

<p>通过浏览器捕获声音，需要借助Web Audio API。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span> <span class="o">||</span>
                      <span class="nb">window</span><span class="p">.</span><span class="nx">webkitAudioContext</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AudioContext</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">onSuccess</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">audioInput</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">createMediaStreamSource</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
	<span class="nx">audioInput</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="na">audio</span><span class="p">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">onSuccess</span><span class="p">);</span>

</code></pre></div></div>

<h3 id="捕获的限定条件">捕获的限定条件</h3>

<p>getUserMedia方法的第一个参数，除了指定捕获对象之外，还可以指定一些限制条件，比如限定只能录制高清（或者VGA标准）的视频。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">hdConstraints</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">video</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">mandatory</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">minWidth</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
      <span class="na">minHeight</span><span class="p">:</span> <span class="mi">720</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">hdConstraints</span><span class="p">,</span> <span class="nx">onSuccess</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">vgaConstraints</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">video</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">mandatory</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">maxWidth</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span>
      <span class="na">maxHeight</span><span class="p">:</span> <span class="mi">360</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">vgaConstraints</span><span class="p">,</span> <span class="nx">onSuccess</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span>

</code></pre></div></div>

<h3 id="mediastreamtrackgetsources">MediaStreamTrack.getSources()</h3>

<p>如果本机有多个摄像头/麦克风，这时就需要使用MediaStreamTrack.getSources方法指定，到底使用哪一个摄像头/麦克风。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">MediaStreamTrack</span><span class="p">.</span><span class="nx">getSources</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">sourceInfos</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">audioSource</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">videoSource</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="nx">sourceInfos</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sourceInfo</span> <span class="o">=</span> <span class="nx">sourceInfos</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="s1">'audio'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">label</span> <span class="o">||</span> <span class="s1">'microphone'</span><span class="p">);</span>

      <span class="nx">audioSource</span> <span class="o">=</span> <span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="s1">'video'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">label</span> <span class="o">||</span> <span class="s1">'camera'</span><span class="p">);</span>

      <span class="nx">videoSource</span> <span class="o">=</span> <span class="nx">sourceInfo</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Some other kind of source: '</span><span class="p">,</span> <span class="nx">sourceInfo</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">sourceSelected</span><span class="p">(</span><span class="nx">audioSource</span><span class="p">,</span> <span class="nx">videoSource</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">sourceSelected</span><span class="p">(</span><span class="nx">audioSource</span><span class="p">,</span> <span class="nx">videoSource</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">constraints</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">audio</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">optional</span><span class="p">:</span> <span class="p">[{</span><span class="na">sourceId</span><span class="p">:</span> <span class="nx">audioSource</span><span class="p">}]</span>
    <span class="p">},</span>
    <span class="na">video</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">optional</span><span class="p">:</span> <span class="p">[{</span><span class="na">sourceId</span><span class="p">:</span> <span class="nx">videoSource</span><span class="p">}]</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">constraints</span><span class="p">,</span> <span class="nx">onSuccess</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>上面代码表示，MediaStreamTrack.getSources方法的回调函数，可以得到一个本机的摄像头和麦克风的列表，然后指定使用最后一个摄像头和麦克风。</p>

<h2 id="rtcpeerconnectionlrtcdatachannel">RTCPeerConnectionl，RTCDataChannel</h2>

<h3 id="rtcpeerconnectionl">RTCPeerConnectionl</h3>

<p>RTCPeerConnection的作用是在浏览器之间建立数据的“点对点”（peer to peer）通信，也就是将浏览器获取的麦克风或摄像头数据，传播给另一个浏览器。这里面包含了很多复杂的工作，比如信号处理、多媒体编码/解码、点对点通信、数据安全、带宽管理等等。</p>

<p>不同客户端之间的音频/视频传递，是不用通过服务器的。但是，两个客户端之间建立联系，需要通过服务器。服务器主要转递两种数据。</p>

<ul>
  <li>通信内容的元数据：打开/关闭对话（session）的命令、媒体文件的元数据（编码格式、媒体类型和带宽）等。</li>
  <li>网络通信的元数据：IP地址、NAT网络地址翻译和防火墙等。</li>
</ul>

<p>WebRTC协议没有规定与服务器的通信方式，因此可以采用各种方式，比如WebSocket。通过服务器，两个客户端按照Session Description Protocol（SDP协议）交换双方的元数据。</p>

<p>下面是一个示例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">signalingChannel</span> <span class="o">=</span> <span class="nx">createSignalingChannel</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">pc</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">configuration</span> <span class="o">=</span> <span class="p">...;</span>

<span class="c1">// run start(true) to initiate a call</span>
<span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">isCaller</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RTCPeerConnection</span><span class="p">(</span><span class="nx">configuration</span><span class="p">);</span>

    <span class="c1">// send any ice candidates to the other peer</span>
    <span class="nx">pc</span><span class="p">.</span><span class="nx">onicecandidate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">signalingChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="s2">"candidate"</span><span class="p">:</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">candidate</span> <span class="p">}));</span>
    <span class="p">};</span>

    <span class="c1">// once remote stream arrives, show it in the remote video element</span>
    <span class="nx">pc</span><span class="p">.</span><span class="nx">onaddstream</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">remoteView</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">stream</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="c1">// get the local stream, show it in the local video element and send it</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span> <span class="s2">"audio"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">"video"</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">selfView</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
        <span class="nx">pc</span><span class="p">.</span><span class="nx">addStream</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">isCaller</span><span class="p">)</span>
            <span class="nx">pc</span><span class="p">.</span><span class="nx">createOffer</span><span class="p">(</span><span class="nx">gotDescription</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">pc</span><span class="p">.</span><span class="nx">createAnswer</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nx">remoteDescription</span><span class="p">,</span> <span class="nx">gotDescription</span><span class="p">);</span>

        <span class="kd">function</span> <span class="nx">gotDescription</span><span class="p">(</span><span class="nx">desc</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pc</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="nx">desc</span><span class="p">);</span>
            <span class="nx">signalingChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="s2">"sdp"</span><span class="p">:</span> <span class="nx">desc</span> <span class="p">}));</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">signalingChannel</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pc</span><span class="p">)</span>
        <span class="nx">start</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">signal</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">signal</span><span class="p">.</span><span class="nx">sdp</span><span class="p">)</span>
        <span class="nx">pc</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="k">new</span> <span class="nx">RTCSessionDescription</span><span class="p">(</span><span class="nx">signal</span><span class="p">.</span><span class="nx">sdp</span><span class="p">));</span>
    <span class="k">else</span>
        <span class="nx">pc</span><span class="p">.</span><span class="nx">addIceCandidate</span><span class="p">(</span><span class="k">new</span> <span class="nx">RTCIceCandidate</span><span class="p">(</span><span class="nx">signal</span><span class="p">.</span><span class="nx">candidate</span><span class="p">));</span>
<span class="p">};</span>

</code></pre></div></div>

<p>RTCPeerConnection带有浏览器前缀，Chrome浏览器中为webkitRTCPeerConnection，Firefox浏览器中为mozRTCPeerConnection。Google维护一个函数库<a href="https://apprtc.appspot.com/js/adapter.js">adapter.js</a>，用来抽象掉浏览器之间的差异。</p>

<h3 id="rtcdatachannel">RTCDataChannel</h3>

<p>RTCDataChannel的作用是在点对点之间，传播任意数据。它的API与WebSockets的API相同。</p>

<p>下面是一个示例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">pc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">webkitRTCPeerConnection</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span>
  <span class="p">{</span><span class="na">optional</span><span class="p">:</span> <span class="p">[{</span><span class="na">RtpDataChannels</span><span class="p">:</span> <span class="kc">true</span><span class="p">}]});</span>

<span class="nx">pc</span><span class="p">.</span><span class="nx">ondatachannel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">receiveChannel</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>
  <span class="nx">receiveChannel</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"div#receive"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">sendChannel</span> <span class="o">=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">createDataChannel</span><span class="p">(</span><span class="s2">"sendDataChannel"</span><span class="p">,</span> <span class="p">{</span><span class="na">reliable</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"button#send"</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"textarea#send"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="nx">sendChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">};</span>

</code></pre></div></div>

<p>Chrome 25、Opera 18和Firefox 22支持RTCDataChannel。</p>

<h3 id="外部函数库">外部函数库</h3>

<p>由于这两个API比较复杂，一般采用外部函数库进行操作。目前，视频聊天的函数库有<a href="https://github.com/henrikjoreteg/SimpleWebRTC">SimpleWebRTC</a>、<a href="https://github.com/priologic/easyrtc">easyRTC</a>、<a href="https://github.com/webRTC/webRTC.io">webRTC.io</a>，点对点通信的函数库有<a href="http://peerjs.com/">PeerJS</a>、<a href="https://github.com/peer5/sharefest">Sharefest</a>。</p>

<p>下面是SimpleWebRTC的示例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">webrtc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebRTC</span><span class="p">({</span>
  <span class="na">localVideoEl</span><span class="p">:</span> <span class="s1">'localVideo'</span><span class="p">,</span>
  <span class="na">remoteVideosEl</span><span class="p">:</span> <span class="s1">'remoteVideos'</span><span class="p">,</span>
  <span class="na">autoRequestMedia</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="nx">webrtc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'readyToCall'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">webrtc</span><span class="p">.</span><span class="nx">joinRoom</span><span class="p">(</span><span class="s1">'My room name'</span><span class="p">);</span>
<span class="p">});</span>

</code></pre></div></div>

<p>下面是PeerJS的示例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">peer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Peer</span><span class="p">(</span><span class="s1">'someid'</span><span class="p">,</span> <span class="p">{</span><span class="na">key</span><span class="p">:</span> <span class="s1">'apikey'</span><span class="p">});</span>
<span class="nx">peer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="c1">// Will print 'hi!'</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Connecting peer</span>
<span class="kd">var</span> <span class="nx">peer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Peer</span><span class="p">(</span><span class="s1">'anotherid'</span><span class="p">,</span> <span class="p">{</span><span class="na">key</span><span class="p">:</span> <span class="s1">'apikey'</span><span class="p">});</span>
<span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'someid'</span><span class="p">);</span>
<span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'open'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">conn</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'hi!'</span><span class="p">);</span>
<span class="p">});</span>

</code></pre></div></div>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li>Andi Smith，<a href="http://www.netmagazine.com/tutorials/get-started-webrtc">Get Started with WebRTC</a></li>
  <li>Thibault Imbert, <a href="http://typedarray.org/from-microphone-to-wav-with-getusermedia-and-web-audio/">From microphone to .WAV with: getUserMedia and Web Audio</a></li>
  <li>Ian Devlin, <a href="http://html5hub.com/using-the-getusermedia-api-with-the-html5-video-and-canvas-elements/#i.bz41ehmmhd3311">Using the getUserMedia API with the HTML5 video and canvas elements</a></li>
  <li>Eric Bidelman, <a href="http://www.html5rocks.com/en/tutorials/getusermedia/intro/">Capturing Audio &amp; Video in HTML5</a></li>
  <li>Sam Dutton, <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">Getting Started with WebRTC</a></li>
  <li>Dan Ristic, <a href="http://www.html5rocks.com/en/tutorials/webrtc/datachannels/">WebRTC data channels</a></li>
  <li>Justin Uberti, Sam Dutton, <a href="http://io13webrtc.appspot.com/">WebRTC: Plugin-free realtime communication</a></li>
  <li>Mozilla Developer Network, <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/API/WebRTC/Taking_webcam_photos">Taking webcam photos</a></li>
  <li>Sam Dutton, <a href="http://www.html5rocks.com/en/tutorials/webrtc/infrastructure/">WebRTC in the real world: STUN, TURN and signaling</a></li>
</ul>


</article>

<div class="row">
<div class="twelve columns">

<h2>留言</h2>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jstutorial'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>

</div>
</div>

<footer>
<div class="row">
<div class="twelve columns">
	<p><a href="/introduction/license.html">版权声明</a> | last modified on 2013-10-04 </p>
</div>
</div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43771063-1', 'ruanyifeng.com');
  ga('send', 'pageview');
</script>
</body>
</html>


