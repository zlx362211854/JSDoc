<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>文件和二进制数据的操作 -- JavaScript 标准参考教程（alpha）</title>
  
  <!-- Included CSS Files (Uncompressed) -->
  <!--
  <link rel="stylesheet" href="stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="/css/foundation.css">
  <link rel="stylesheet" href="/css/main.css">

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script src="/js/jquery.js"></script>
  <script src="/js/toc.js"></script>
  <script src="/js/main.js"></script>

</head>
<body>

<header class="top-bar" id="header">

<div class="fixed">

<nav class="top-bar">
<ul>
<!-- Title Area -->
	<li class="name has-dropdown">
	<h1><a href="/">JavaScript 标准参考教程（alpha） </a></h1>
		<ul class="dropdown">
			
			<li><a href="/#introduction">导论</a></li>
			
			<li><a href="/#grammar">语法</a></li>
			
			<li><a href="/#stdlib">标准库</a></li>
			
			<li><a href="/#oop">面向对象编程</a></li>
			
			<li><a href="/#advanced">语法专题</a></li>
			
			<li><a href="/#dom">DOM模型</a></li>
			
			<li><a href="/#bom">浏览器环境</a></li>
			
			<li><a href="/#htmlapi">Web API</a></li>
			
		</ul>
	</li>
</ul>

<section>


<ul class="left">
<li class="divider"></li>
<li class="has-dropdown"><a class="active" href="#"> Web API </a><ul class="dropdown">





































































<li><a href="/htmlapi/elements.html">概述</a></li>















<li><a href="/htmlapi/eventsource.html">Server-Sent Events</a></li>







<li class="active"><a href="#">文件和二进制数据的操作</a></li>





<li><a href="/htmlapi/form.html">表单</a></li>









<li><a href="/htmlapi/fullscreen.html">Fullscreen API：全屏操作</a></li>











































































<li><a href="/htmlapi/pagevisibility.html">Page Visibility API</a></li>





























<li><a href="/htmlapi/requestanimationframe.html">requestAnimationFrame</a></li>



























<li><a href="/htmlapi/svg.html">SVG 图像</a></li>





















<li><a href="/htmlapi/webcomponents.html">Web Components</a></li>









<li><a href="/htmlapi/webspeech.html">Web Speech</a></li>







<li><a href="/htmlapi/webworker.html">Web Worker</a></li>







</ul></li>
<li class="divider"></li>
<li class="has-dropdown nav-3"><a href="#"> 文件和二进制数据的操作</a><ul class="dropdown">
</ul></li>
</ul>


<ul class="right">
	<li class="divider"></li>
	<li>
		<a href="https://github.com/ruanyf/jstutorial" target="_blank">GitHub <i class="foundicon-edit"></i></a>
	</li>
	<li class="divider"></li>
	<li>
		<a href="#">TOP <i class="foundicon-up-arrow"></i></a>
	</li>
</ul>

</section>

</nav>  
</div>
</header>


<article class="bookPage">

  <div class="row">
    <div class="twelve columns">

<h1> 文件和二进制数据的操作 </h1>

<aside class="right"><p>来自<a href="/">《JavaScript 标准参考教程（alpha）》</a>，by 阮一峰</p></aside>

<div id="toc" class="panel callout radius">目录</div>


<p>历史上，JavaScript无法处理二进制数据。如果一定要处理的话，只能使用charCodeAt()方法，一个个字节地从文字编码转成二进制数据，还有一种办法是将二进制数据转成Base64编码，再进行处理。这两种方法不仅速度慢，而且容易出错。ECMAScript 5引入了Blob对象，允许直接操作二进制数据。</p>

<p>Blob对象是一个代表二进制数据的基本对象，在它的基础上，又衍生出一系列相关的API，用来操作文件。</p>

<ul>
  <li>File对象：负责处理那些以文件形式存在的二进制数据，也就是操作本地文件；</li>
  <li>FileList对象：File对象的网页表单接口；</li>
  <li>FileReader对象：负责将二进制数据读入内存内容；</li>
  <li>URL对象：用于对二进制数据生成URL。</li>
</ul>

<h2 id="blob对象">Blob对象</h2>

<p>Blob（Binary Large Object）对象代表了一段二进制数据，提供了一系列操作接口。其他操作二进制数据的API（比如File对象），都是建立在Blob对象基础上的，继承了它的属性和方法。</p>

<p>生成Blob对象有两种方法：一种是使用Blob构造函数，另一种是对现有的Blob对象使用slice方法切出一部分。</p>

<p>（1）Blob构造函数，接受两个参数。第一个参数是一个包含实际数据的数组，第二个参数是数据的类型，这两个参数都不是必需的。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">htmlParts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"&lt;a id=</span><span class="se">\"</span><span class="s2">a</span><span class="se">\"</span><span class="s2">&gt;&lt;b id=</span><span class="se">\"</span><span class="s2">b</span><span class="se">\"</span><span class="s2">&gt;hey!&lt;</span><span class="err">\</span><span class="s2">/b&gt;&lt;</span><span class="err">\</span><span class="s2">/a&gt;"</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">myBlob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">(</span><span class="nx">htmlParts</span><span class="p">,</span> <span class="p">{</span> <span class="s2">"type"</span> <span class="p">:</span> <span class="s2">"text</span><span class="err">\</span><span class="s2">/xml"</span> <span class="p">});</span>
</code></pre></div></div>

<p>下面是一个利用Blob对象，生成可下载文件的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s2">"Hello World"</span><span class="p">]);</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"a"</span><span class="p">);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="s2">"hello-world.txt"</span><span class="p">;</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">"Download Hello World!"</span><span class="p">;</span>

<span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
</code></pre></div></div>

<p>上面的代码生成了一个超级链接，点击后提示下载文本文件hello-world.txt，文件内容为“Hello World”。</p>

<p>（2）Blob对象的slice方法，将二进制数据按照字节分块，返回一个新的Blob对象。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">newBlob</span> <span class="o">=</span> <span class="nx">oldBlob</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">startingByte</span><span class="p">,</span> <span class="nx">endindByte</span><span class="p">);</span>
</code></pre></div></div>

<p>下面是一个使用XMLHttpRequest对象，将大文件分割上传的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">upload</span><span class="p">(</span><span class="nx">blobOrFile</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'/server'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">blobOrFile</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'input[type="file"]'</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="kd">const</span> <span class="nx">BYTES_PER_CHUNK</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span> <span class="c1">// 1MB chunk sizes.</span>
  <span class="kd">const</span> <span class="nx">SIZE</span> <span class="o">=</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">BYTES_PER_CHUNK</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">SIZE</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">upload</span><span class="p">(</span><span class="nx">blob</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">));</span>

    <span class="nx">start</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
    <span class="nx">end</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">BYTES_PER_CHUNK</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

<span class="p">})();</span>
</code></pre></div></div>

<p>（3）Blob对象有两个只读属性：</p>

<ul>
  <li>size：二进制数据的大小，单位为字节。</li>
  <li>type：二进制数据的MIME类型，全部为小写，如果类型未知，则该值为空字符串。</li>
</ul>

<p>在Ajax操作中，如果xhr.responseType设为blob，接收的就是二进制数据。</p>

<h2 id="filelist对象">FileList对象</h2>

<p>FileList对象针对表单的file控件。当用户通过file控件选取文件后，这个控件的files属性值就是FileList对象。它在结构上类似于数组，包含用户选取的多个文件。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">id=</span><span class="s">"input"</span> <span class="na">onchange=</span><span class="s">"console.log(this.files.length)"</span> <span class="na">multiple</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>当用户选取文件后，就可以读取该文件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">selected_file</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'input'</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div>

<p>采用拖放方式，也可以得到FileList对象。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">dropZone</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'drop_zone'</span><span class="p">);</span>
<span class="nx">dropZone</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'drop'</span><span class="p">,</span> <span class="nx">handleFileSelect</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">handleFileSelect</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">evt</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span> <span class="c1">// FileList object.</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上面代码的 handleFileSelect 是拖放事件的回调函数，它的参数evt是一个事件对象，该参数的dataTransfer.files属性就是一个FileList对象，里面包含了拖放的文件。</p>

<h2 id="file-api">File API</h2>

<p>File API提供<code class="highlighter-rouge">File</code>对象，它是<code class="highlighter-rouge">FileList</code>对象的成员，包含了文件的一些元信息，比如文件名、上次改动时间、文件大小和文件类型。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">selected_file</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'input'</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">selected_file</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fileSize</span> <span class="o">=</span> <span class="nx">selected_file</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fileType</span> <span class="o">=</span> <span class="nx">selected_file</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">File</code>对象的属性值如下。</p>

<ul>
  <li><code class="highlighter-rouge">name</code>：文件名，该属性只读。</li>
  <li><code class="highlighter-rouge">size</code>：文件大小，单位为字节，该属性只读。</li>
  <li><code class="highlighter-rouge">type</code>：文件的MIME类型，如果分辨不出类型，则为空字符串，该属性只读。</li>
  <li><code class="highlighter-rouge">lastModified</code>：文件的上次修改时间，格式为时间戳。</li>
  <li><code class="highlighter-rouge">lastModifiedDate</code>：文件的上次修改时间，格式为<code class="highlighter-rouge">Date</code>对象实例。</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="s1">'#upload-file'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">// {</span>
<span class="c1">//   lastModified: 1449370355682,</span>
<span class="c1">//   lastModifiedDate: Sun Dec 06 2015 10:52:35 GMT+0800 (CST),</span>
<span class="c1">//   name: "HTTP 2 is here Goodbye SPDY Not quite yet.png",</span>
<span class="c1">//   size: 17044,</span>
<span class="c1">//   type: "image/png"</span>
<span class="c1">// }</span>
</code></pre></div></div>

<h2 id="filereader-api">FileReader API</h2>

<p>FileReader API用于读取文件，即把文件内容读入内存。它的参数是<code class="highlighter-rouge">File</code>对象或<code class="highlighter-rouge">Blob</code>对象。</p>

<p>对于不同类型的文件，FileReader提供不同的方法读取文件。</p>

<ul>
  <li><code class="highlighter-rouge">readAsBinaryString(Blob|File)</code>：返回二进制字符串，该字符串每个字节包含一个0到255之间的整数。</li>
  <li><code class="highlighter-rouge">readAsText(Blob|File, opt_encoding)</code>：返回文本字符串。默认情况下，文本编码格式是’UTF-8’，可以通过可选的格式参数，指定其他编码格式的文本。</li>
  <li><code class="highlighter-rouge">readAsDataURL(Blob|File)</code>：返回一个基于Base64编码的data-uri对象。</li>
  <li><code class="highlighter-rouge">readAsArrayBuffer(Blob|File)</code>：返回一个ArrayBuffer对象。</li>
</ul>

<p><code class="highlighter-rouge">readAsText</code>方法用于读取文本文件，它的第一个参数是<code class="highlighter-rouge">File</code>或<code class="highlighter-rouge">Blob</code>对象，第二个参数是前一个参数的编码方法，如果省略就默认为<code class="highlighter-rouge">UTF-8</code>编码。该方法是异步方法，一般监听<code class="highlighter-rouge">onload</code>件，用来确定文件是否加载结束，方法是判断<code class="highlighter-rouge">FileReader</code>实例的<code class="highlighter-rouge">result</code>属性是否有值。其他三种读取方法，用法与<code class="highlighter-rouge">readAsText</code>方法类似。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">readAsDataURL</code>方法返回一个data URL，它的作用基本上是将文件数据进行Base64编码。你可以将返回值设为图像的<code class="highlighter-rouge">src</code>属性。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'destination'</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'image'</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dataURL</span> <span class="o">=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">readAsBinaryString</code>方法可以读取任意类型的文件，而不仅仅是文本文件，返回文件的原始的二进制内容。这个方法与XMLHttpRequest.sendAsBinary方法结合使用，就可以使用JavaScript上传任意文件到服务器。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rawData</span> <span class="o">=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">readAsBinaryString</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">readAsArrayBuffer</code>方法读取文件，返回一个类型化数组（ArrayBuffer），即固定长度的二进制缓存数据。在文件操作时（比如将JPEG图像转为PNG图像），这个方法非常方便。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">arrayBuffer</span> <span class="o">=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">reader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</code></pre></div></div>

<p>除了以上四种不同的读取文件方法，FileReader API还有一个<code class="highlighter-rouge">abort</code>方法，用于中止文件上传。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</code></pre></div></div>

<p>FileReader对象采用异步方式读取文件，可以为一系列事件指定回调函数。</p>

<ul>
  <li>onabort方法：读取中断或调用reader.abort()方法时触发。</li>
  <li>onerror方法：读取出错时触发。</li>
  <li>onload方法：读取成功后触发。</li>
  <li>onloadend方法：读取完成后触发，不管是否成功。触发顺序排在 onload 或 onerror 后面。</li>
  <li>onloadstart方法：读取将要开始时触发。</li>
  <li>onprogress方法：读取过程中周期性触发。</li>
</ul>

<p>下面的代码是如何展示文本文件的内容。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">onload</code>事件的回调函数接受一个事件对象，该对象的<code class="highlighter-rouge">target.result</code>就是文件的内容。</p>

<p>下面是一个使用<code class="highlighter-rouge">readAsDataURL</code>方法，为<code class="highlighter-rouge">img</code>元素添加<code class="highlighter-rouge">src</code>属性的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</code></pre></div></div>

<p>下面是一个<code class="highlighter-rouge">onerror</code>事件回调函数的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">errorHandler</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">errorHandler</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">NOT_FOUND_ERR</span><span class="p">:</span>
      <span class="nx">alert</span><span class="p">(</span><span class="s1">'File Not Found!'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">NOT_READABLE_ERR</span><span class="p">:</span>
      <span class="nx">alert</span><span class="p">(</span><span class="s1">'File is not readable'</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">ABORT_ERR</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default</span><span class="p">:</span>
      <span class="nx">alert</span><span class="p">(</span><span class="s1">'An error occurred reading this file.'</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>下面是一个<code class="highlighter-rouge">onprogress</code>事件回调函数的例子，主要用来显示读取进度。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="nx">reader</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="nx">updateProgress</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">updateProgress</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">lengthComputable</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">percentLoaded</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">evt</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">totalEric</span> <span class="nx">Bidelman</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">progress</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'.percent'</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">percentLoaded</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">progress</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">percentLoaded</span> <span class="o">+</span> <span class="s1">'%'</span><span class="p">;</span>
      <span class="nx">progress</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">percentLoaded</span> <span class="o">+</span> <span class="s1">'%'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>读取大文件的时候，可以利用<code class="highlighter-rouge">Blob</code>对象的<code class="highlighter-rouge">slice</code>方法，将大文件分成小段，逐一读取，这样可以加快处理速度。</p>

<h2 id="综合实例显示用户选取的本地图片">综合实例：显示用户选取的本地图片</h2>

<p>假设有一个表单，用于用户选取图片。</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"picture"</span> <span class="na">accept=</span><span class="s">"image/png, image/jpeg"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>一旦用户选中图片，将其显示在canvas的函数可以这样写：</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'input[name=picture]'</span><span class="p">).</span><span class="nx">onchange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
     <span class="nx">readFile</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">){</span>

  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>

  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">applyDataUrlToCanvas</span><span class="p">(</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span> <span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>还可以在canvas上面定义拖放事件，允许用户直接拖放图片到上面。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// stop FireFox from replacing the whole page with the file.</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">ondragover</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">};</span>

<span class="c1">// Add drop handler</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">ondrop</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> 
  <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">files</span><span class="p">){</span>
    <span class="nx">readFile</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

<p>所有的拖放事件都有一个dataTransfer属性，它包含拖放过程涉及的二进制数据。</p>

<p>还可以让canvas显示剪贴板中的图片。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">document</span><span class="p">.</span><span class="nx">onpaste</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clipboardData</span><span class="o">&amp;&amp;</span><span class="nx">e</span><span class="p">.</span><span class="nx">clipboardData</span><span class="p">.</span><span class="nx">items</span><span class="p">){</span>
    <span class="c1">// pasted image</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clipboardData</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">kind</span><span class="o">===</span><span class="s1">'file'</span> <span class="o">&amp;&amp;</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^image/</span><span class="p">)</span> <span class="p">){</span>
        <span class="nx">readFile</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getAsFile</span><span class="p">());</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<h2 id="url对象">URL对象</h2>

<p>URL对象用于生成指向File对象或Blob对象的URL。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">objecturl</span> <span class="o">=</span>  <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span></code></pre></figure>

<p>上面的代码会对二进制数据生成一个URL，类似于“blob:http%3A//test.com/666e6730-f45c-47c1-8012-ccc706f17191”。这个URL可以放置于任何通常可以放置URL的地方，比如img标签的src属性。需要注意的是，即使是同样的二进制数据，每调用一次URL.createObjectURL方法，就会得到一个不一样的URL。</p>

<p>这个URL的存在时间，等同于网页的存在时间，一旦网页刷新或卸载，这个URL就失效。除此之外，也可以手动调用URL.revokeObjectURL方法，使URL失效。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">objectURL</span><span class="p">);</span></code></pre></figure>

<p>下面是一个利用URL对象，在网页插入图片的例子。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"img"</span><span class="p">);</span>

<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="nx">img</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

<span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"span"</span><span class="p">);</span>

<span class="nx">info</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">": "</span> <span class="o">+</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">size</span> <span class="o">+</span> <span class="s2">" bytes"</span><span class="p">;</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">info</span><span class="p">);</span></code></pre></figure>

<p>还有一个本机视频预览的例子。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'video'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">obj_url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
<span class="nx">video</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">obj_url</span><span class="p">;</span>
<span class="nx">video</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">obj_url</span><span class="p">);</span></code></pre></figure>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li><a href="http://www.w3.org/TR/FileAPI/">W3C Working Draft</a></li>
  <li>Andrew Dodson, <a href="http://msdn.microsoft.com/en-gb/magazine/jj835793.aspx">Get Loaded with the File API</a></li>
  <li>Mozilla Developer Network，<a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">Using files from web applications</a></li>
  <li><a href="http://javascript-reverse.tumblr.com/post/37056936789/html5-download-attribute">HTML5 download attribute</a></li>
  <li>Eric Bidelman, <a href="http://www.html5rocks.com/en/tutorials/file/dndfiles/">Reading files in JavaScript using the File APIs</a></li>
  <li>Matt West, <a href="http://blog.teamtreehouse.com/reading-files-using-the-html5-filereader-api">Reading Files Using The HTML5 FileReader API</a></li>
</ul>


</article>

<div class="row">
<div class="twelve columns">

<h2>留言</h2>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jstutorial'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>

</div>
</div>

<footer>
<div class="row">
<div class="twelve columns">
	<p><a href="/introduction/license.html">版权声明</a> | last modified on 2013-09-06 </p>
</div>
</div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43771063-1', 'ruanyifeng.com');
  ga('send', 'pageview');
</script>
</body>
</html>


