<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>PhantomJS -- JavaScript 标准参考教程（alpha）</title>
  
  <!-- Included CSS Files (Uncompressed) -->
  <!--
  <link rel="stylesheet" href="stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="/css/foundation.css">
  <link rel="stylesheet" href="/css/main.css">

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script src="/js/jquery.js"></script>
  <script src="/js/toc.js"></script>
  <script src="/js/main.js"></script>

</head>
<body>

<header class="top-bar" id="header">

<div class="fixed">

<nav class="top-bar">
<ul>
<!-- Title Area -->
	<li class="name has-dropdown">
	<h1><a href="/">JavaScript 标准参考教程（alpha） </a></h1>
		<ul class="dropdown">
			
			<li><a href="/#introduction">导论</a></li>
			
			<li><a href="/#grammar">语法</a></li>
			
			<li><a href="/#stdlib">标准库</a></li>
			
			<li><a href="/#oop">面向对象编程</a></li>
			
			<li><a href="/#advanced">语法专题</a></li>
			
			<li><a href="/#dom">DOM模型</a></li>
			
			<li><a href="/#bom">浏览器环境</a></li>
			
			<li><a href="/#htmlapi">Web API</a></li>
			
		</ul>
	</li>
</ul>

<section>


<ul class="left">
<li class="divider"></li>
<li class="has-dropdown"><a class="active" href="#"> 开发工具 </a><ul class="dropdown">





























<li><a href="/tool/bower.html">Bower：客户端库管理工具</a></li>





<li><a href="/tool/browserify.html">Browserify：浏览器加载Node.js模块</a></li>











<li><a href="/stdlib/console.html">console对象</a></li>





























































<li><a href="/tool/grunt.html">Grunt：任务自动管理工具</a></li>





<li><a href="/tool/gulp.html">Gulp：任务自动管理工具</a></li>































<li><a href="/tool/lint.html">Lint 工具</a></li>

















































<li class="active"><a href="#">PhantomJS</a></li>























<li><a href="/tool/requirejs.html">RequireJS和AMD规范</a></li>













<li><a href="/tool/sourcemap.html">Source Map</a></li>

















<li><a href="/tool/testing.html">JavaScript 程序测试</a></li>

































</ul></li>
<li class="divider"></li>
<li class="has-dropdown nav-3"><a href="#"> PhantomJS</a><ul class="dropdown">
</ul></li>
</ul>


<ul class="right">
	<li class="divider"></li>
	<li>
		<a href="https://github.com/ruanyf/jstutorial" target="_blank">GitHub <i class="foundicon-edit"></i></a>
	</li>
	<li class="divider"></li>
	<li>
		<a href="#">TOP <i class="foundicon-up-arrow"></i></a>
	</li>
</ul>

</section>

</nav>  
</div>
</header>


<article class="bookPage">

  <div class="row">
    <div class="twelve columns">

<h1> PhantomJS </h1>

<aside class="right"><p>来自<a href="/">《JavaScript 标准参考教程（alpha）》</a>，by 阮一峰</p></aside>

<div id="toc" class="panel callout radius">目录</div>


<h2 id="概述">概述</h2>

<p>有时，我们需要浏览器处理网页，但并不需要浏览，比如生成网页的截图、抓取网页数据等操作。<a href="http://phantomjs.org/">PhantomJS</a>的功能，就是提供一个浏览器环境的命令行接口，你可以把它看作一个“虚拟浏览器”，除了不能浏览，其他与正常浏览器一样。它的内核是WebKit引擎，不提供图形界面，只能在命令行下使用，我们可以用它完成一些特殊的用途。</p>

<p>PhantomJS是二进制程序，需要<a href="http://phantomjs.org/download.html">安装</a>后使用。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>phantomjs <span class="nt">-g</span>
</code></pre></div></div>

<p>使用下面的命令，查看是否安装成功。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>phantomjs <span class="nt">--version</span>
</code></pre></div></div>

<h2 id="repl环境">REPL环境</h2>

<p>phantomjs提供了一个完整的REPL环境，允许用户通过命令行与PhantomJS互动。键入phantomjs，就进入了该环境。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>phantomjs
</code></pre></div></div>

<p>这时会跳出一个phantom提示符，就可以输入Javascript命令了。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phantomjs&gt; 1+2
3

phantomjs&gt; <span class="k">function </span>add<span class="o">(</span>a,b<span class="o">)</span> <span class="o">{</span> <span class="k">return </span>a+b<span class="p">;</span> <span class="o">}</span>
undefined

phantomjs&gt; add<span class="o">(</span>1,2<span class="o">)</span>
3
</code></pre></div></div>

<p>按ctrl+c可以退出该环境。</p>

<p>下面，我们把上面的add()函数写成一个文件add.js文件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// add.js</span>

<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span> <span class="k">return</span> <span class="nx">a</span><span class="o">+</span><span class="nx">b</span><span class="p">;</span> <span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>

<span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
</code></pre></div></div>

<p>上面的代码中，console.log()的作用是在终端窗口显示，phantom.exit()则表示退出phantomjs环境。一般来说，不管什么样的程序，exit这一行都不能少。</p>

<p>现在，运行该程序。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>phantomjs add.js
</code></pre></div></div>

<p>终端窗口就会显示结果为3。</p>

<p>下面是更多的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">phantomjs</span><span class="o">&gt;</span> <span class="nx">phantom</span><span class="p">.</span><span class="nx">version</span>
<span class="p">{</span>
  <span class="s2">"major"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">"minor"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="s2">"patch"</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="nx">phantomjs</span><span class="o">&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"phantom is awesome"</span><span class="p">)</span>
<span class="nx">phantom</span> <span class="nx">is</span> <span class="nx">awesome</span>

<span class="nx">phantomjs</span><span class="o">&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nb">navigator</span>
<span class="p">{</span>
  <span class="s2">"cookieEnabled"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">"language"</span><span class="p">:</span> <span class="s2">"en-GB"</span><span class="p">,</span>
  <span class="s2">"productSub"</span><span class="p">:</span> <span class="s2">"20030107"</span><span class="p">,</span>
  <span class="s2">"product"</span><span class="p">:</span> <span class="s2">"Gecko"</span><span class="p">,</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="webpage模块">webpage模块</h2>

<p>webpage模块是PhantomJS的核心模块，用于网页操作。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</code></pre></div></div>

<p>上面代码表示加载PhantomJS的webpage模块，并创建一个实例。</p>

<p>下面是webpage实例的属性和方法介绍。</p>

<h3 id="open">open()</h3>

<p>open方法用于打开具体的网页。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://slashdot.org'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
  <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，open()方法，用于打开具体的网页。它接受两个参数。第一个参数是网页的网址，这里打开的是著名新闻网站<a href="http://slashdot.org">Slashdot</a>，第二个参数是回调函数，网页打开后该函数将会运行，它的参数是一个表示状态的字符串，如果打开成功就是success，否则就是fail。</p>

<p>注意，只要接收到服务器返回的结果，PhantomJS就会报告网页打开成功，而不管服务器是否返回404或500错误。</p>

<p>open方法默认使用GET方法，与服务器通信，但是也可以使用其他方法。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">postBody</span> <span class="o">=</span> <span class="s1">'user=username&amp;password=password'</span><span class="p">;</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://www.google.com/'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">,</span> <span class="nx">postBody</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Status: '</span> <span class="o">+</span> <span class="nx">status</span><span class="p">);</span>
  <span class="c1">// Do other things here...</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，使用POST方法向服务器发送数据。open方法的第二个参数用来指定HTTP方法，第三个参数用来指定该方法所要使用的数据。</p>

<p>open方法还允许提供配置对象，对HTTP请求进行更详细的配置。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">operation</span><span class="p">:</span> <span class="s2">"POST"</span><span class="p">,</span>
  <span class="na">encoding</span><span class="p">:</span> <span class="s2">"utf8"</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"application/json"</span>
  <span class="p">},</span>
  <span class="na">data</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
    <span class="na">some</span><span class="p">:</span> <span class="s2">"data"</span><span class="p">,</span>
    <span class="na">another</span><span class="p">:</span> <span class="p">[</span><span class="s2">"custom"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">]</span>
  <span class="p">})</span>
<span class="p">};</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://your.custom.api'</span><span class="p">,</span> <span class="nx">settings</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Status: '</span> <span class="o">+</span> <span class="nx">status</span><span class="p">);</span>
  <span class="c1">// Do other things here...</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="evaluate">evaluate()</h3>

<p>evaluate方法用于打开网页以后，在页面中执行JavaScript代码。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Page title is '</span> <span class="o">+</span> <span class="nx">title</span><span class="p">);</span>
  <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>

</code></pre></div></div>

<p>网页内部的console语句，以及evaluate方法内部的console语句，默认不会显示在命令行。这时可以采用onConsoleMessage回调函数，上面的例子可以改写如下。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">onConsoleMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Page title is '</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>

</code></pre></div></div>

<p>上面代码中，evaluate方法内部有console语句，默认不会输出在命令行。这时，可以用onConsoleMessage方法监听这个事件，进行处理。</p>

<h3 id="includejs">includeJs()</h3>

<p>includeJs方法用于页面加载外部脚本，加载结束后就调用指定的回调函数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://www.sample.com'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">includeJs</span><span class="p">(</span><span class="s2">"http://path/to/jquery.min.js"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">"button"</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面的例子在页面中注入jQuery脚本，然后点击所有的按钮。需要注意的是，由于是异步加载，所以<code class="highlighter-rouge">phantom.exit()</code>语句要放在<code class="highlighter-rouge">page.includeJs()</code>方法的回调函数之中，否则页面会过早退出。</p>

<h3 id="render">render()</h3>

<p>render方法用于将网页保存成图片，参数就是指定的文件名。该方法根据后缀名，将网页保存成不同的格式，目前支持PNG、GIF、JPEG和PDF。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">viewportSize</span> <span class="o">=</span> <span class="p">{</span> <span class="na">width</span><span class="p">:</span> <span class="mi">1920</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span> <span class="mi">1080</span> <span class="p">};</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"http://www.google.com"</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'google_home.jpeg'</span><span class="p">,</span> <span class="p">{</span><span class="na">format</span><span class="p">:</span> <span class="s1">'jpeg'</span><span class="p">,</span> <span class="na">quality</span><span class="p">:</span> <span class="s1">'100'</span><span class="p">});</span>
  <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>该方法还可以接受一个配置对象，format字段用于指定图片格式，quality字段用于指定图片质量，最小为0，最大为100。</p>

<h3 id="viewportsizezoomfactor">viewportSize，zoomFactor</h3>

<p>viewportSize属性指定浏览器视口的大小，即网页加载的初始浏览器窗口大小。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">viewportSize</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">width</span><span class="p">:</span> <span class="mi">480</span><span class="p">,</span>
  <span class="na">height</span><span class="p">:</span> <span class="mi">800</span>
<span class="p">};</span>
</code></pre></div></div>

<p>viewportSize的Height字段必须指定，不可省略。</p>

<p>zoomFactor属性用来指定渲染时（render方法和renderBase64方法）页面的放大系数，默认是1（即100%）。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">zoomFactor</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'capture.png'</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="onresourcerequested">onResourceRequested</h3>

<p>onResourceRequested属性用来指定一个回调函数，当页面请求一个资源时，会触发这个回调函数。它的第一个参数是HTTP请求的元数据对象，第二个参数是发出的网络请求对象。</p>

<p>HTTP请求包括以下字段。</p>

<ul>
  <li>id：所请求资源的编号</li>
  <li>method：使用的HTTP方法</li>
  <li>url：所请求的资源 URL</li>
  <li>time：一个包含请求时间的Date对象</li>
  <li>headers：HTTP头信息数组</li>
</ul>

<p>网络请求对象包含以下方法。</p>

<ul>
  <li>abort()：终止当前的网络请求，这会导致调用onResourceError回调函数。</li>
  <li>changeUrl(newUrl)：改变当前网络请求的URL。</li>
  <li>setHeader(key, value)：设置HTTP头信息。</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">onResourceRequested</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">requestData</span><span class="p">,</span> <span class="nx">networkRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Request (#'</span> <span class="o">+</span> <span class="nx">requestData</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">'): '</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">requestData</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="onresourcereceived">onResourceReceived</h3>

<p>onResourceReceived属性用于指定一个回调函数，当网页收到所请求的资源时，就会执行该回调函数。它的参数就是服务器发来的HTTP回应的元数据对象，包括以下字段。</p>

<ul>
  <li>id：所请求的资源编号</li>
  <li>url：所请求的资源的URL
r- time：包含HTTP回应时间的Date对象</li>
  <li>headers：HTTP头信息数组</li>
  <li>bodySize：解压缩后的收到的内容大小</li>
  <li>contentType：接到的内容种类</li>
  <li>redirectURL：重定向URL（如果有的话）</li>
  <li>stage：对于多数据块的HTTP回应，头一个数据块为start，最后一个数据块为end。</li>
  <li>status：HTTP状态码，成功时为200。</li>
  <li>statusText：HTTP状态信息，比如OK。</li>
</ul>

<p>如果HTTP回应非常大，分成多个数据块发送，onResourceReceived会在收到每个数据块时触发回调函数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">webPage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">webPage</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">onResourceReceived</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Response (#'</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">', stage "'</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">stage</span> <span class="o">+</span> <span class="s1">'"): '</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="system模块">system模块</h2>

<p>system模块可以加载操作系统变量，system.args就是参数数组。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">(),</span>
    <span class="nx">system</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'system'</span><span class="p">),</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">address</span><span class="p">;</span>

<span class="c1">// 如果命令行没有给出网址</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">system</span><span class="p">.</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Usage: page.js &lt;some URL&gt;'</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">t</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="nx">address</span> <span class="o">=</span> <span class="nx">system</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">'success'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'FAIL to load the address'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Loading time '</span> <span class="o">+</span> <span class="nx">t</span> <span class="o">+</span> <span class="s1">' ms'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure>

<p>使用方法如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>phantomjs page.js http://www.google.com
</code></pre></div></div>

<h2 id="应用">应用</h2>

<p>Phantomjs可以实现多种应用。</p>

<h3 id="过滤资源">过滤资源</h3>

<p>处理页面的时候，有时不希望加载某些特定资源。这时，可以对URL进行匹配，一旦符合规则，就中断对资源的连接。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">page</span><span class="p">.</span><span class="nx">onResourceRequested</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">requestData</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="sr">/http:</span><span class="se">\/\/</span><span class="sr">.+</span><span class="se">?\.</span><span class="sr">css$/gi</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">requestData</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Skipping'</span><span class="p">,</span> <span class="nx">requestData</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
  <span class="p">}</span>   
<span class="p">};</span>

</code></pre></div></div>

<p>上面代码一旦发现加载的资源是CSS文件，就会使用<code class="highlighter-rouge">request.abort</code>方法中断连接。</p>

<h3 id="截图">截图</h3>

<p>最简单的生成网页截图的方法如下。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'google.png'</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure>

<p>page对象代表一个网页实例；open方法表示打开某个网址，它的第一个参数是目标网址，第二个参数是网页载入成功后，运行的回调函数;render方法则是渲染页面，然后以图片格式输出，该方法的参数就是输出的图片文件名。</p>

<p>除了简单截图以外，还可以设置各种截图参数。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://google.com'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">zoomFactor</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">page</span><span class="p">.</span><span class="nx">renderBase64</span><span class="p">());</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
<span class="p">});</span></code></pre></figure>

<p>zoomFactor表示将截图缩小至原图的25%大小；renderBase64方法则是表示将截图（PNG格式）编码成Base64格式的字符串输出。</p>

<p>下面的例子则是使用了更多参数。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// page.js</span>

<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">userAgent</span> <span class="o">=</span> <span class="s1">'WebKit/534.46 Mobile/9A405 Safari/7534.48.3'</span><span class="p">;</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">viewportSize</span> <span class="o">=</span> <span class="p">{</span> <span class="na">width</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span> <span class="mi">600</span> <span class="p">};</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'http://slashdot.org'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">'success'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Unable to load!'</span><span class="p">);</span>
    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  	  <span class="kd">var</span> <span class="nx">posts</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s2">"article"</span><span class="p">);</span>
		  <span class="nx">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">"#FFF"</span><span class="p">;</span>
		  <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
	  <span class="p">});</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">page</span><span class="p">.</span><span class="nx">clipRect</span> <span class="o">=</span> <span class="p">{</span> <span class="na">top</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">width</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span> <span class="mi">700</span> <span class="p">};</span>
	    <span class="nx">page</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">title</span> <span class="o">+</span> <span class="s2">"1.png"</span><span class="p">);</span>
	    <span class="nx">page</span><span class="p">.</span><span class="nx">clipRect</span> <span class="o">=</span> <span class="p">{</span> <span class="na">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">top</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="na">width</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span> <span class="mi">600</span> <span class="p">};</span>
      <span class="nx">page</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">'2.png'</span><span class="p">);</span>
	    <span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>	  
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>上面代码中的几个属性和方法解释如下：</p>

<ul>
  <li>settings.userAgent：指定HTTP请求的userAgent头信息，上面例子是手机浏览器的userAgent。</li>
  <li>settings.viewportSize：指定浏览器窗口的大小，这里是400x600。</li>
  <li>evaluate()：用来在网页上运行Javascript代码。在这里，我们抓取第一条新闻，然后修改背景颜色，并返回该条新闻的标题。</li>
  <li>clipRect：用来指定网页截图的大小，这里的截图左上角从网页的(0. 0)坐标开始，宽600像素，高700像素。如果不指定这个值，就表示对整张网页截图。</li>
  <li>render()：根据clipRect的范围，在当前目录下生成以第一条新闻的名字命名的截图。</li>
</ul>

<h3 id="抓取图片">抓取图片</h3>

<p>使用官方网站提供的<a href="https://github.com/ariya/phantomjs/blob/master/examples/rasterize.js">rasterize.js</a>，可以抓取网络上的图片，将起保存在本地。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">phantomjs</span> <span class="nx">rasterize</span><span class="p">.</span><span class="nx">js</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//ariya.github.com/svg/tiger.svg tiger.png</span></code></pre></figure>

<p>使用<a href="https://github.com/ariya/phantomjs/blob/master/examples/rasterize.js">rasterize.js</a>，还可以将网页保存为pdf文件。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">phantomjs</span> <span class="nx">rasterize</span><span class="p">.</span><span class="nx">js</span> <span class="s1">'http://en.wikipedia.org/w/index.php?title=Jakarta&amp;printable=yes'</span> <span class="nx">jakarta</span><span class="p">.</span><span class="nx">pdf</span></code></pre></figure>

<h3 id="生成网页">生成网页</h3>

<p>phantomjs可以生成网页，使用content方法指定网页的HTML代码。</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'webpage'</span><span class="p">).</span><span class="nx">create</span><span class="p">();</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">viewportSize</span> <span class="o">=</span> <span class="p">{</span> <span class="na">width</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="na">height</span> <span class="p">:</span> <span class="mi">400</span> <span class="p">};</span>
<span class="nx">page</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s1">'&lt;html&gt;&lt;body&gt;&lt;canvas id="surface"&gt;&lt;/canvas&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="p">;</span>
<span class="nx">phantom</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span></code></pre></figure>

<p>官方网站有一个<a href="https://github.com/ariya/phantomjs/blob/master/examples/colorwheel.js">例子</a>，通过创造svg图片，然后截图保存成png文件。</p>

<p><img src="https://lh3.googleusercontent.com/-xSIzxPtJULw/TVzeP4NPMDI/AAAAAAAAB10/k-c8jB6I5Cg/s288/colorwheel.png" alt="" /></p>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li><a href="http://net.tutsplus.com/tutorials/javascript-ajax/testing-javascript-with-phantomjs/">Testing JavaScript with PhantomJS</a></li>
  <li><a href="https://github.com/ariya/phantomjs/wiki/Quick-Start">Phantom Quick Start</a></li>
  <li>Ariya Hidayat, <a href="http://ariya.ofilabs.com/2013/04/web-page-clipping-with-phantomjs.html">Web Page Clipping with PhantomJS</a></li>
  <li>BenjaminBenBen, <a href="http://benjaminbenben.com/2013/07/28/phantomjs-webserver/">Using PhantomJS WebServer</a></li>
  <li>Ariya Hidayat, <a href="http://ariya.ofilabs.com/2013/06/capturing-web-page-without-stylesheets.html">Capturing Web Page Without Stylesheets</a>: 过滤CSS文件</li>
</ul>


</article>

<div class="row">
<div class="twelve columns">

<h2>留言</h2>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jstutorial'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>

</div>
</div>

<footer>
<div class="row">
<div class="twelve columns">
	<p><a href="/introduction/license.html">版权声明</a> | last modified on 2013-08-07 </p>
</div>
</div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43771063-1', 'ruanyifeng.com');
  ga('send', 'pageview');
</script>
</body>
</html>


