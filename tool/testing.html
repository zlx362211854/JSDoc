<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>JavaScript 程序测试 -- JavaScript 标准参考教程（alpha）</title>
  
  <!-- Included CSS Files (Uncompressed) -->
  <!--
  <link rel="stylesheet" href="stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="/css/foundation.css">
  <link rel="stylesheet" href="/css/main.css">

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script src="/js/jquery.js"></script>
  <script src="/js/toc.js"></script>
  <script src="/js/main.js"></script>

</head>
<body>

<header class="top-bar" id="header">

<div class="fixed">

<nav class="top-bar">
<ul>
<!-- Title Area -->
	<li class="name has-dropdown">
	<h1><a href="/">JavaScript 标准参考教程（alpha） </a></h1>
		<ul class="dropdown">
			
			<li><a href="/#introduction">导论</a></li>
			
			<li><a href="/#grammar">语法</a></li>
			
			<li><a href="/#stdlib">标准库</a></li>
			
			<li><a href="/#oop">面向对象编程</a></li>
			
			<li><a href="/#advanced">语法专题</a></li>
			
			<li><a href="/#dom">DOM模型</a></li>
			
			<li><a href="/#bom">浏览器环境</a></li>
			
			<li><a href="/#htmlapi">Web API</a></li>
			
		</ul>
	</li>
</ul>

<section>


<ul class="left">
<li class="divider"></li>
<li class="has-dropdown"><a class="active" href="#"> 开发工具 </a><ul class="dropdown">





























<li><a href="/tool/bower.html">Bower：客户端库管理工具</a></li>





<li><a href="/tool/browserify.html">Browserify：浏览器加载Node.js模块</a></li>











<li><a href="/stdlib/console.html">console对象</a></li>





























































<li><a href="/tool/grunt.html">Grunt：任务自动管理工具</a></li>





<li><a href="/tool/gulp.html">Gulp：任务自动管理工具</a></li>































<li><a href="/tool/lint.html">Lint 工具</a></li>

















































<li><a href="/tool/phantomjs.html">PhantomJS</a></li>























<li><a href="/tool/requirejs.html">RequireJS和AMD规范</a></li>













<li><a href="/tool/sourcemap.html">Source Map</a></li>

















<li class="active"><a href="#">JavaScript 程序测试</a></li>

































</ul></li>
<li class="divider"></li>
<li class="has-dropdown nav-3"><a href="#"> JavaScript 程序测试</a><ul class="dropdown">
</ul></li>
</ul>


<ul class="right">
	<li class="divider"></li>
	<li>
		<a href="https://github.com/ruanyf/jstutorial" target="_blank">GitHub <i class="foundicon-edit"></i></a>
	</li>
	<li class="divider"></li>
	<li>
		<a href="#">TOP <i class="foundicon-up-arrow"></i></a>
	</li>
</ul>

</section>

</nav>  
</div>
</header>


<article class="bookPage">

  <div class="row">
    <div class="twelve columns">

<h1> JavaScript 程序测试 </h1>

<aside class="right"><p>来自<a href="/">《JavaScript 标准参考教程（alpha）》</a>，by 阮一峰</p></aside>

<div id="toc" class="panel callout radius">目录</div>


<h2 id="为什么要写测试">为什么要写测试？</h2>

<p>Web应用程序越来越复杂，这意味着有更多的可能出错。测试是帮助我们提高代码质量、降低错误的最好方法和工具之一。</p>

<ul>
  <li>测试可以确保得到预期结果。</li>
  <li>加快开发速度。</li>
  <li>方便维护。</li>
  <li>提供用法的文档。</li>
</ul>

<p>通过测试提供软件的质量，在开始的时候，可能会降低开发速度。但是从长期看，尤其是那种代码需要长期维护、不断开发的情况，测试会大大加快开发速度，减轻维护难度。</p>

<h2 id="测试的类型">测试的类型</h2>

<h3 id="单元测试">单元测试</h3>

<p>单元测试（unit testing）指的是以软件的单元（unit）为单位，对软件进行测试。单元可以是一个函数，也可以是一个模块或组件。它的基本特征就是，只要输入不变，必定返回同样的输出。</p>

<p>“单元测试”这个词，本身就暗示，软件应该以模块化结构存在。每个模块的运作，是独立于其他模块的。一个软件越容易写单元测试，往往暗示着它的模块化结构越好，各模块之间的耦合就越弱；越难写单元测试，或者每次单元测试，不得不模拟大量的外部条件，很可能暗示软件的模块化结构越差，模块之间存在较强的耦合。</p>

<p>单元测试的要求是，每个模块都必须有单元测试，而软件由模块组成。</p>

<p>单元测试通常采取断言（assertion）的形式，也就是测试某个功能的返回结果，是否与预期结果一致。如果与预期不一致，就表示测试失败。</p>

<p>单元测试是函数正常工作、不出错的最基本、最有效的方法之一。 每一个单元测试发出一个特定的输入到所要测试的函数，看看函数是否返回预期的输出，或者采取了预期的行动。单元测试证明了所测试的代码行为符合预期。</p>

<p>单元测试有助于代码的模块化，因此有助于长期的重用。因为有了测试，你就知道代码是可靠的，可以按照预期运行。从这个角度说，测试可以节省开发时间。单元测试的另一个好处是，有了测试，就等于就有了代码功能的文档，有助于其他开发者了解代码的意图。</p>

<p>单元测试应该避免依赖性问题，比如不存取数据库、不访问网络等等，而是使用工具虚拟出运行环境。这种虚拟使得测试成本最小化，不用花大力气搭建各种测试环境。</p>

<p>一般来说，单元测试的步骤如下。</p>

<ul>
  <li>准备所有的测试条件</li>
  <li>调用（触发）所要测试的函数</li>
  <li>验证运行结果是否正确</li>
  <li>还原被修改的记录</li>
</ul>

<h3 id="其他测试类型">其他测试类型</h3>

<p>（1）集成测试</p>

<p>集成测试（Integration test）指的是多个部分在一起测试，比如测试一个数据库连接模块，是否能够连接数据库。</p>

<p>（2）功能测试</p>

<p>功能测试（Functional test）指的是，自动测试整个应用程序的某个功能，比如使用Selenium工具自动打开浏览器运行程序。</p>

<p>（3）端对端测试</p>

<p>端对端测试（End-to-End testing）指的是全链路测试，即从开始端到终止端的测试，比如测试从用户界面、通过网络、经过应用程序处理、到达数据库，是否能够返回正确结果。端对端测试的目的是，确保整个系统能够正常运行，各个子系统之间依赖关系正常，数据能够在子系统之间、模块之间正确传递。</p>

<p>（4）冒烟测试</p>

<p>冒烟测试（smoke testing）指的是，正式的全面测试开始之前，对主要功能进行的预测试。它的主要目的是，确认主要功能能否满足需要，软件是否能运行。冒烟测试可以是手工测试，也可以是自动化测试。</p>

<p>这个名字最早来自对电子元件的测试，第一次对电子元件通电，看看它是否会冒烟。如果没有冒烟，说明通过了测试；如果电流达到某个临界点之后，才出现冒烟，这时可以评估是否能够接受这个临界点。</p>

<h2 id="开发模式">开发模式</h2>

<p>测试不仅能够验证软件功能、保证代码质量，也能够影响软件开发的模式。</p>

<h3 id="tdd">TDD</h3>

<p>TDD是“测试驱动的开发”（Test-Driven Development）的简称，指的是先写好测试，然后再根据测试完成开发。使用这种开发方式，会有很高的测试覆盖率。</p>

<p>TDD的开发步骤如下。</p>

<ul>
  <li>先写一个测试。</li>
  <li>写出最小数量的代码，使其能够通过测试。</li>
  <li>优化代码。</li>
  <li>重复前面三步。</li>
</ul>

<p>TDD开发的测试覆盖率通常在90%以上，这意味着维护代码和新增特性会非常容易。因为测试保证了你可以信任这些代码，修改它们不会破坏其他代码的运行。</p>

<p>TDD接口提供以下四个方法。</p>

<ul>
  <li>suite()</li>
  <li>test()</li>
  <li>setup()</li>
  <li>teardown()</li>
</ul>

<p>下面代码是测试计数器是否加1。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">suite</span><span class="p">(</span><span class="s1">'Counter'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">'tick increases count to 1'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Counter</span><span class="p">();</span>
    <span class="nx">counter</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">counter</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="bdd">BDD</h3>

<p>BDD是“行为驱动的开发”（Behavior-Driven Development）的简称，指的是写出优秀测试的最佳实践的总称。</p>

<p>BDD认为，不应该针对代码的实现细节写测试，而是要针对行为写测试。BDD测试的是行为，即软件应该怎样运行。</p>

<p>BDD接口提供以下六个方法。</p>

<ul>
  <li>describe()</li>
  <li>it()</li>
  <li>before()</li>
  <li>after()</li>
  <li>beforeEach()</li>
  <li>afterEach()</li>
</ul>

<p>下面是测试计数器是否加1的BDD写法。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Counter'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should increase count by 1 after calling tick'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Counter</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">expectedCount</span> <span class="o">=</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">counter</span><span class="p">.</span><span class="nx">tick</span><span class="p">();</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">counter</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="nx">expectedCount</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>下面是一个BDD开发的示例。现在，需要开发一个<code class="highlighter-rouge">Foo</code>类，该类的实例有一个<code class="highlighter-rouge">sayHi</code>方法，会对类参数说“Hi”。这就是<code class="highlighter-rouge">Foo</code>类的规格，根据这个规格，我们可以写出测试用例文件<code class="highlighter-rouge">foo.spec.js</code>。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'Simple object'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">foo</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">(</span><span class="s1">'John'</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should say hi'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">foo</span><span class="p">.</span><span class="nx">sayHi</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'John says hi!'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>有了测试用例以后，我们再写出实际的脚本文件<code class="highlighter-rouge">foo.js</code>。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Foo</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Foo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sayHi</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">' says hi!'</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>为了把测试用例与脚本文件分开，我们通常把测试用例放在<code class="highlighter-rouge">test</code>子目录之中。然后，我们就可以使用Mocha、Jasmine等测试框架，执行测试用例，看看脚本文件是否通过测试。</p>

<h3 id="bdd术语">BDD术语</h3>

<p>（1）测试套件</p>

<p>测试套件（test suite）指的是，一组针对软件规格的某个方面的测试用例。也可以看作，对软件的某个方面的描述（describe）。</p>

<p>测试套件由一个<code class="highlighter-rouge">describe</code>函数构成，它接受两个参数：第一个参数是字符串，表示测试套件的名字或标题，表示将要测试什么；第二个参数是函数，用来实现这个测试套件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s2">"A suite"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div></div>

<p>（2）测试用例</p>

<p>测试用例（test case）指的是，针对软件一个功能点的测试，是软件测试的最基本单位。一组相关的测试用例，构成一个测试套件。测试用例由<code class="highlighter-rouge">it</code>函数构成，它与<code class="highlighter-rouge">describe</code>函数一样，接受两个参数：第一个参数是字符串，表示测试用例的标题；第二个参数是函数，用来实现这个测试用例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s2">"A suite"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s2">"contains spec with an expectation"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>（3）断言</p>

<p>断言（assert）指的是对代码行为的预期。一个测试用例内部，包含一个或多个断言（assert）。</p>

<p>断言会返回一个布尔值，表示代码行为是否符合预期。测试用例之中，只要有一个断言为false，这个测试用例就会失败，只有所有断言都为<code class="highlighter-rouge">true</code>，测试用例才会通过。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s2">"A suite"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s2">"contains spec with an expectation"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="断言">断言</h2>

<p>断言是判断实际值与预期值是否相等的工具。</p>

<p>断言有assert、expect、should三种风格，或者称为三种写法。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// assert风格</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="s1">'(item)‘);

// expect风格
expect(event.detail.item).to.equal('</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="s1">');

// should风格
event.detail.item.should.equal('</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span><span class="s1">');
</span></code></pre></div></div>

<p>Chai.js是一个很流行的断言库，同时支持上面三种风格。</p>

<p>（1） assert风格</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">assert</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">beverages</span> <span class="o">=</span> <span class="p">{</span> <span class="na">tea</span><span class="p">:</span> <span class="p">[</span> <span class="s1">'chai'</span><span class="p">,</span> <span class="s1">'matcha'</span><span class="p">,</span> <span class="s1">'oolong'</span> <span class="p">]</span> <span class="p">};</span>

<span class="nx">assert</span><span class="p">.</span><span class="nx">typeOf</span><span class="p">(</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">,</span> <span class="s1">'foo is a string'</span><span class="p">);</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="s1">'foo equal `bar`'</span><span class="p">);</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="nx">foo</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'foo`s value has a length of 3'</span><span class="p">);</span>
<span class="nx">assert</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span><span class="nx">beverages</span><span class="p">.</span><span class="nx">tea</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'beverages has 3 types of tea'</span><span class="p">);</span>
</code></pre></div></div>

<p>上面代码中，assert方法的最后一个参数是错误提示信息，只有测试没有通过时，才会显示。</p>

<p>（2）expect风格</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">beverages</span> <span class="o">=</span> <span class="p">{</span> <span class="na">tea</span><span class="p">:</span> <span class="p">[</span> <span class="s1">'chai'</span><span class="p">,</span> <span class="s1">'matcha'</span><span class="p">,</span> <span class="s1">'oolong'</span> <span class="p">]</span> <span class="p">};</span>

<span class="nx">expect</span><span class="p">(</span><span class="nx">foo</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="s1">'string'</span><span class="p">);</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">foo</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">);</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">foo</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">beverages</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'tea'</span><span class="p">).</span><span class="kd">with</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</code></pre></div></div>

<p>（3）should风格</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">should</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">should</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">beverages</span> <span class="o">=</span> <span class="p">{</span> <span class="na">tea</span><span class="p">:</span> <span class="p">[</span> <span class="s1">'chai'</span><span class="p">,</span> <span class="s1">'matcha'</span><span class="p">,</span> <span class="s1">'oolong'</span> <span class="p">]</span> <span class="p">};</span>

<span class="nx">foo</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="s1">'string'</span><span class="p">);</span>
<span class="nx">foo</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">);</span>
<span class="nx">foo</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="nx">beverages</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'tea'</span><span class="p">).</span><span class="kd">with</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="mochajs">Mocha.js</h2>

<h3 id="概述">概述</h3>

<p>Mocha（发音“摩卡”）是现在最流行的前端测试框架之一，此外常用的测试框架还有<a href="http://jasmine.github.io/">Jasmine</a>、<a href="https://github.com/substack/tape/">Tape</a>、<a href="https://github.com/defunctzombie/zuul/">zuul</a>等。所谓“测试框架”，就是运行测试的工具。</p>

<p>Mocha使用下面的命令安装。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 全局安装</span>
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-g</span> mocha chai

<span class="c"># 项目内安装</span>
<span class="nv">$ </span>npm i <span class="nt">-D</span> mocha chai
</code></pre></div></div>

<p>上面代码中，除了安装Mocha以外，还安装了断言库<code class="highlighter-rouge">chai</code>，这是因为Mocha自身不带断言库，必须安装外部断言库。</p>

<p>测试套件文件一般放在<code class="highlighter-rouge">test</code>子目录下面，配置文件<code class="highlighter-rouge">mocha.opts</code>也放在这个目录里面。</p>

<h3 id="浏览器测试">浏览器测试</h3>

<p>使用浏览器测试时，先用<code class="highlighter-rouge">mocha init</code>命令在指定目录生成初始化文件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha init &lt;path&gt;
</code></pre></div></div>

<p>运行上面命令，就会在该目录下生成一个<code class="highlighter-rouge">index.html</code>文件，以及配套的脚本和样式表。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Unit.js tests in the browser with Mocha<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"mocha.css"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Unit.js tests in the browser with Mocha<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"mocha"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"mocha.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="nx">mocha</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="s1">'bdd'</span><span class="p">);</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="nx">mocha</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>然后在该文件中，加入你要测试的文件（比如<code class="highlighter-rouge">app.js</code>）、测试脚本（<code class="highlighter-rouge">app.spec.js</code>）和断言库（<code class="highlighter-rouge">chai.js</code>）。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://chaijs.com/chai.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.spec.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>各个文件的内容如下。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app.js</span>
<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// app.spec.js</span>
<span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">chai</span><span class="p">.</span><span class="nx">expect</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'测试add函数'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'1加1应该等于2'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="命令行测试">命令行测试</h3>

<p>Mocha除了在浏览器运行，还可以在命令行运行。</p>

<p>还是使用上面的文件，作为例子，但是要改成CommonJS格式。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app.js</span>
<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">){</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">add</span><span class="p">;</span>

<span class="c1">// app.spec.js</span>
<span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">add</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../app'</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'测试add函数'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'1加1应该等于2'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>然后，在命令行下执行<code class="highlighter-rouge">mocha</code>，就会执行测试。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha
</code></pre></div></div>

<p>上面的命令等同于下面的形式。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nb">test</span> <span class="nt">--reporter</span> spec <span class="nt">--recursive</span> <span class="nt">--growl</span>
</code></pre></div></div>

<h3 id="mochaopts">mocha.opts</h3>

<p>所有Mocha的命令行参数，都可以写在<code class="highlighter-rouge">test</code>目录下的配置文件<code class="highlighter-rouge">mocha.opts</code>之中。</p>

<p>下面是一个典型的配置文件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">--</span><span class="nx">reporter</span> <span class="nx">spec</span>
<span class="o">--</span><span class="nx">recursive</span>
<span class="o">--</span><span class="nx">growl</span>
</code></pre></div></div>

<p>上面三个设置的含义如下。</p>

<ul>
  <li>使用spec报告模板</li>
  <li>包括子目录</li>
  <li>打开桌面通知插件growl</li>
</ul>

<p>如果希望测试非存放于test子目录的测试用例，可以在<code class="highlighter-rouge">mocha.opts</code>写入以下内容。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server-tests
<span class="nt">--recursive</span>
</code></pre></div></div>

<p>上面代码指定运行<code class="highlighter-rouge">server-tests</code>目录及其子目录之中的测试脚本。</p>

<h3 id="生成规格文件">生成规格文件</h3>

<p>Mocha支持从测试用例生成规格文件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nb">test</span>/app.spec.js <span class="nt">-R</span> markdown <span class="o">&gt;</span> spec.md
</code></pre></div></div>

<p>上面命令生成单个<code class="highlighter-rouge">app.spec.js</code>规格。</p>

<p>生成HTML格式的报告，使用下面的命令。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nb">test</span>/app.spec.js <span class="nt">-R</span> doc <span class="o">&gt;</span> spec.html
</code></pre></div></div>

<p>如果要生成整个<code class="highlighter-rouge">test</code>目录，对应的规格文件，使用下面的命令。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nb">test</span> <span class="nt">-R</span> markdown <span class="o">&gt;</span> spec.md <span class="nt">--recursive</span>
</code></pre></div></div>

<p>只要提供测试脚本的路径，Mocha就可以运行这个测试脚本。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span> <span class="nx">mocha</span> <span class="o">-</span><span class="nx">w</span> <span class="nx">src</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">test</span><span class="p">.</span><span class="nx">js</span>
</code></pre></div></div>

<p>上面命令运行测试脚本<code class="highlighter-rouge">src/index.test.js</code>，参数<code class="highlighter-rouge">-w</code>表示watch，即当这个脚本一有变动，就会运行。</p>

<p>指定测试脚本时，可以使用通配符，同时指定多个文件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--reporter</span> spec spec/<span class="o">{</span>my,awesome<span class="o">}</span>.js
<span class="nv">$ </span>mocha <span class="nt">--ui</span> tdd <span class="nb">test</span>/unit/<span class="k">*</span>.js etc
</code></pre></div></div>

<p>上面代码中，参数<code class="highlighter-rouge">--reporter</code>指定生成的报告格式（上面代码是spec格式），<code class="highlighter-rouge">-ui</code>指定采用哪一种测试模式（上面代码是tdd模式）。</p>

<p>除了使用shell通配符，还可以使用node通配符。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--compilers</span> js:babel-core/register <span class="s1">'test/**/*.@(js|jsx)'</span>
</code></pre></div></div>

<p>上面代码指定运行<code class="highlighter-rouge">test</code>目录下面任何子目录中，文件后缀名为<code class="highlighter-rouge">js</code>或<code class="highlighter-rouge">jsx</code>的测试脚本。注意，Node的通配符要放在单引号之中，因为否则星号（<code class="highlighter-rouge">*</code>）会先被shell解释。</p>

<p>如果要改用shell通配符，执行<code class="highlighter-rouge">test</code>目录下面任何子目录的测试脚本，要写成下面这样。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nb">test</span>/<span class="k">**</span>.js
</code></pre></div></div>

<p>如果测试脚本不止一个，最好将它们放在专门的目录当中。Mocha默认执行<code class="highlighter-rouge">test</code>目录的测试脚本，所以可以将所有测试脚本放在<code class="highlighter-rouge">test</code>子目录。<code class="highlighter-rouge">--recursive</code>参数可以指定运行子目录之中的测试脚本。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--recursive</span>
</code></pre></div></div>

<p>上面命令会运行<code class="highlighter-rouge">test</code>子目录之中的所有测试脚本。</p>

<p><code class="highlighter-rouge">--grep</code>参数用于搜索测试用例的名称（即it方法的第一个参数），然后只执行匹配的测试用例。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--reporter</span> spec <span class="nt">--grep</span> <span class="s2">"Fnord:"</span> server-test/<span class="k">*</span>.js
</code></pre></div></div>

<p>上面代码只测试名称中包含“Fnord：”的测试用例。</p>

<p><code class="highlighter-rouge">--invert</code>参数表示只运行不符合条件的测试脚本。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--grep</span> auth <span class="nt">--invert</span>
</code></pre></div></div>

<p>如果测试脚本用到了ES6语法，还需要用<code class="highlighter-rouge">--compiler</code>参数指定babel进行转码。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--compilers</span> js:babel/register <span class="nt">--recursive</span>
</code></pre></div></div>

<p>上面命令会在运行测试脚本之前，先用Babel进行转码。<code class="highlighter-rouge">--compilers</code>参数的值是用冒号分隔的一个字符串，冒号左边是文件的后缀名，右边是用来处理这一类文件的模块名。上面代码表示，运行测试之前，先用<code class="highlighter-rouge">babel/register</code>模块，处理一下JS文件。</p>

<p><code class="highlighter-rouge">--require</code>参数指定测试脚本默认包含的文件。下面是一个<code class="highlighter-rouge">test_helper.js</code>文件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// test/test_helper.js</span>
<span class="k">import</span> <span class="nx">chai</span> <span class="k">from</span> <span class="s1">'chai'</span><span class="p">;</span>
</code></pre></div></div>

<p>使用<code class="highlighter-rouge">--require</code>参数，将上面这个脚本包含进所有测试脚本。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mocha <span class="nt">--compilers</span> js:babel/register <span class="nt">--require</span> ./test/test_helper.js  <span class="nt">--recursive</span>
</code></pre></div></div>

<h3 id="测试脚本的写法">测试脚本的写法</h3>

<p>测试脚本中，describe方法和it方法都允许调用only方法，表示只运行某个测试套件或测试用例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例一</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">'Array'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">describe</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s1">'#indexOf()'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="p">...</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// 例二</span>
<span class="nx">describe</span><span class="p">(</span><span class="s2">"using only"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s2">"this is the only test to be run"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s2">"this is not run"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，只有带有<code class="highlighter-rouge">only</code>方法的测试套件或测试用例会运行。</p>

<p>describe方法和it方法还可以调用skip方法，表示跳过指定的测试套件或测试用例。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例一</span>
<span class="nx">describe</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="s1">'Article'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>

<span class="c1">// 例二</span>
<span class="nx">describe</span><span class="p">(</span><span class="s2">"using only"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="s2">"this is the only test to be run"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s2">"this is not run"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，带有<code class="highlighter-rouge">skip</code>方法的测试套件或测试用例会被忽略。</p>

<p>如果测试用例包含异步操作，可以done方法显式指定测试用例的运行结束时间。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'logs a'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'logs a'</span><span class="p">);</span>
    <span class="nx">done</span><span class="p">();</span>
  <span class="p">};</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，正常情况下，函数f还没有执行，Mocha就已经结束运行了。为了保证Mocha等到测试用例跑完再结束运行，可以手动调用done方法</p>

<h2 id="promise的测试">Promise的测试</h2>

<p>对于异步的测试，测试用例之中，通常必须调用<code class="highlighter-rouge">done</code>方法，显式表明异步操作的结束。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>

<span class="nx">it</span><span class="p">(</span><span class="s1">'should do something with promises'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">asyncTest</span><span class="p">();</span>

  <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'foobar'</span><span class="p">);</span>
    <span class="nx">done</span><span class="p">();</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">done</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码之中，Promise对象的<code class="highlighter-rouge">then</code>方法之中，必须指定<code class="highlighter-rouge">reject</code>时的回调函数，并且使用<code class="highlighter-rouge">assert.fail</code>方法抛出错误，否则这个错误就不会被外界感知。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">blah</span><span class="p">);</span>
  <span class="nx">done</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码之中，如果Promise被<code class="highlighter-rouge">reject</code>，是不会被捕获的，因为Promise之中的错误，不会”泄漏“到外界。</p>

<p>Mocha内置了对Promise的支持。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should fail the test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'Promise被reject'</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">p</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，Mocha能够捕获<code class="highlighter-rouge">reject</code>的Promise。</p>

<p>因此，使用Mocha时，Promise的测试可以简化成下面的写法。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'chai'</span><span class="p">).</span><span class="nx">expect</span><span class="p">;</span>

<span class="nx">it</span><span class="p">(</span><span class="s1">'should do something with promises'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">asyncTest</span><span class="p">();</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'foobar'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="模拟数据">模拟数据</h2>

<p>单元测试时，很多时候，测试的代码会请求HTTP服务器。这时，我们就需要模拟服务器的回应，不能在单元测试时去请求真实服务器数据，否则就不叫单元测试了，而是连同服务器一起测试了。</p>

<p>一些工具库可以模拟服务器回应。</p>

<ul>
  <li><a href="https://github.com/pgte/nock">nock</a></li>
  <li><a href="http://sinonjs.org/docs/#server">sinon</a></li>
  <li><a href="https://github.com/algolia/faux-jax">faux-jax</a></li>
  <li><a href="https://github.com/moll/node-mitm">MITM</a></li>
</ul>

<h2 id="覆盖率">覆盖率</h2>

<p>测试的覆盖率需要安装istanbul模块。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm i <span class="nt">-D</span> istanbul
</code></pre></div></div>

<p>然后，在package.json设置运行覆盖率检查的命令。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"scripts"</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">"test:cover"</span><span class="p">:</span> <span class="s2">"istanbul cover -x *.test.js _mocha -- -R spec src/index.test.js"</span><span class="p">,</span>
  <span class="s2">"check-coverage"</span><span class="p">:</span> <span class="s2">"istanbul check-coverage --statements 100 --branches 100 --functions 100 --lines 100"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上面代码中，<code class="highlighter-rouge">test:cover</code>是生成覆盖率报告，<code class="highlighter-rouge">check-coverage</code>是设置覆盖率通过的门槛。</p>

<p>然后，将<code class="highlighter-rouge">coverage</code>目录写入<code class="highlighter-rouge">.gitignore</code>防止连这个目录一起提交。</p>

<p>如果希望在<code class="highlighter-rouge">git commit</code>提交之前，先运行一次测试，可以安装ghooks模块，配置<code class="highlighter-rouge">pre-commit</code>钩子。</p>

<p>安装ghooks。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm i <span class="nt">-D</span> ghooks
</code></pre></div></div>

<p>在package.json之中，配置<code class="highlighter-rouge">pre-commit</code>钩子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"config"</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">"ghooks"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"pre-commit"</span><span class="p">:</span> <span class="s2">"npm run test:cover &amp;&amp; npm run check-coverage"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>还可以把覆盖率检查，加入<code class="highlighter-rouge">.travis.yml</code>文件。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script:
  - npm run <span class="nb">test</span>:cover
  - npm run check-coverage
</code></pre></div></div>

<p>如果测试脚本使用ES6，<code class="highlighter-rouge">scripts</code>字段还需要加入Babel转码。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"scripts"</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">"test"</span><span class="p">:</span> <span class="s2">"mocha src/index.test.js -w --compilers js:babel/register"</span><span class="p">,</span>
  <span class="s2">"test:cover"</span><span class="p">:</span> <span class="s2">"istanbul cover -x *.test.js _mocha -- -R spec src/index.test.js --compilers js:babel/register"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>覆盖率报告可以上传到<a href="https://codecov.io/">codecov.io</a>。先安装这个模块。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm i <span class="nt">-D</span> codecov.io
</code></pre></div></div>

<p>然后在package.json增加一个字段。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"scripts"</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">"report-coverage"</span><span class="p">:</span> <span class="s2">"cat ./coverage/lcov.info | codecov"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最后，在CI的配置文件<code class="highlighter-rouge">.travis.yml</code>之中，增加运行这个命令。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>after_success:
  - npm run report-coverage
  - npm run semantic-release
</code></pre></div></div>

<h2 id="webdriver">WebDriver</h2>

<p>WebDriver是一个浏览器的自动化框架。它在各种浏览器的基础上，提供一个统一接口，将接收到的指令转为浏览器的原生指令，驱动浏览器。</p>

<p>WebDriver由Selenium项目演变而来。Selenium是一个测试自动化框架，它的1.0版叫做Selenium RC，通过一个代理服务器，将测试脚本转为JavaScript脚本，注入不同的浏览器，再由浏览器执行这些脚本后返回结果。WebDriver就是Selenium 2.0，它对每个浏览器提供一个驱动，测试脚本通过驱动转换为浏览器原生命令，在浏览器中执行。</p>

<h3 id="定制测试环境">定制测试环境</h3>

<p>DesiredCapabilities对象用于定制测试环境。</p>

<ul>
  <li>定制DesiredCapabilities对象的各个属性</li>
  <li>创建DesiredCapabilities实例</li>
  <li>将DesiredCapabilities实例作为参数，新建一个WebDriver实例</li>
</ul>

<h3 id="操作浏览器的方法">操作浏览器的方法</h3>

<p>WebDriver提供以下方法操作浏览器。</p>

<p>close()：退出或关闭当前浏览器窗口。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</code></pre></div></div>

<p>quit()：关闭所有浏览器窗口，中止当前浏览器driver和session。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
</code></pre></div></div>

<p>getTitle()：返回当前网页的标题。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">getTitle</span><span class="p">();</span>
</code></pre></div></div>

<p>getCurrentUrl()：返回当前网页的网址。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">getCurrentUrl</span><span class="p">();</span>
</code></pre></div></div>

<p>getPageSource()：返回当前网页的源码。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 断言是否含有指定文本</span>
<span class="nx">assert</span><span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">getPageSource</span><span class="p">().</span><span class="nx">contains</span><span class="p">(</span><span class="s2">"Hello World"</span><span class="p">),</span>
  <span class="s2">"预期含有文本Hello World"</span><span class="p">);</span>
</code></pre></div></div>

<p>click()：模拟鼠标点击。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例一</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">click</span><span class="p">();</span>

<span class="c1">// 例二</span>
<span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"webDriver"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="s2">"sblsbb"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">click</span><span class="p">();</span>
</code></pre></div></div>

<p>clear()：清空文本输入框。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例一</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)).</span><span class="nx">clear</span><span class="p">();</span>

<span class="c1">// 例二</span>
<span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"webDriver"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"testing"</span><span class="p">);</span>
</code></pre></div></div>

<p>sendKeys()：在文本输入框输入文本。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"your text"</span><span class="p">);</span>
</code></pre></div></div>

<p>submit()：提交表单，或者用来模拟按下回车键。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例一</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">submit</span><span class="p">();</span>

<span class="c1">// 例二</span>
<span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"webdriver"</span><span class="p">);</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
</code></pre></div></div>

<p>findElement()：返回选中的第一个元素。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="s2">"lst-ib"</span><span class="p">));</span>
</code></pre></div></div>

<p>findElements()：返回选中的所有元素（0个或多个）。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例一</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="s2">"searchbox"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"webdriver"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElements</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">xpath</span><span class="p">(</span><span class="s2">"//div[3]/ul/li"</span><span class="p">))</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">click</span><span class="p">();</span>

<span class="c1">// 例二</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElements</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">tagName</span><span class="p">(</span><span class="s2">"select"</span><span class="p">))</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">findElements</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">tagName</span><span class="p">(</span><span class="s2">"option"</span><span class="p">))</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">click</span><span class="p">()</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">click</span><span class="p">()</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">click</span><span class="p">();</span>

<span class="c1">// 例三：获取页面所有链接</span>
<span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="nx">driver</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">findElements</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">tagName</span><span class="p">(</span><span class="s2">"a"</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">linkSize</span> <span class="o">=</span> <span class="nx">links</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">linksSrc</span> <span class="o">=</span> <span class="p">[];</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">linkSize</span><span class="p">);</span>

<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">linkSize</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="err"> </span> <span class="nx">linksSrc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">links</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"href"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">for</span><span class="p">(</span><span class="kr">int</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">linkSize</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
<span class="err"> </span> <span class="nx">driver</span><span class="p">.</span><span class="nx">navigate</span><span class="p">().</span><span class="nx">to</span><span class="p">(</span><span class="nx">linksSrc</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="err"> </span> <span class="nx">Thread</span><span class="p">.</span><span class="nx">sleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>可以使用<code class="highlighter-rouge">size()</code>，查看到底选中了多少个元素。</p>

<h3 id="网页元素的定位">网页元素的定位</h3>

<p>WebDriver提供8种定位器，用于定位网页元素。</p>

<ul>
  <li>By.id：HTML元素的id属性</li>
  <li>By.name：HTML元素的name属性</li>
  <li>By.xpath：使用XPath语法选中HTML元素</li>
  <li>By.cssSelector：使用CSS选择器语法</li>
  <li>By.className：HTML元素的class属性</li>
  <li>By.linkText：链接文本（只用于选中链接）</li>
  <li>By.tagName：HTML元素的标签名</li>
  <li>By.partialLinkText：部分链接文本（只用于选中链接）</li>
</ul>

<p>下面是一个使用id定位器，选中网页元素的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="s2">"sblsbb"</span><span class="p">)).</span><span class="nx">click</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="网页元素的方法">网页元素的方法</h3>

<p>以下方法属于网页元素的方法，而不是webDriver实例的方法。需要注意的是，有些方法是某些元素特有的，比如只有文本框才能输入文字。如果在网页元素上调用不支持的方法，WebDriver不会报错，也不会给出给出任何提示，只会静静地忽略。</p>

<p>getAttribute()：返回网页元素指定属性的值。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">xpath</span><span class="p">(</span><span class="s2">"//div[@id='lst-ib']"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"class"</span><span class="p">);</span>
</code></pre></div></div>

<p>getText()：返回网页元素的内部文本。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)).</span><span class="nx">getText</span><span class="p">();</span>
</code></pre></div></div>

<p>getTagName()：返回指定元素的标签名。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">xpath</span><span class="p">(</span><span class="s2">"//div[@class='sbib_b']"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">getTagName</span><span class="p">();</span>
</code></pre></div></div>

<p>isDisplayed()：返回一个布尔值，表示元素是否可见。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">assert</span><span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">isDisplayed</span><span class="p">(),</span>
  <span class="s1">'搜索框应该可选择'</span><span class="p">);</span>
</code></pre></div></div>

<p>isEnabled()：返回一个布尔值，表示文本框是否可编辑。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Element</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">isEnabled</span><span class="p">())</span> <span class="p">{</span>
<span class="err"> </span> <span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">"q"</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"Selenium Essentials"</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="err"> </span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>isSelected()：返回一个布尔值，表示一个元素是否可选择。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">xpath</span><span class="p">(</span><span class="s2">"//select[@name='jump']/option[1]"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">isSelected</span><span class="p">()</span>
</code></pre></div></div>

<p>getSize()：返回一个网页元素的宽度和高度。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">dimensions</span><span class="o">=</span><span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">getSize</span><span class="p">();</span><span class="err"> </span>
<span class="nx">dimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
<span class="nx">dimensions</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
</code></pre></div></div>

<p>getLocation()：返回网页元素左上角的x坐标和y坐标。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)).</span><span class="nx">getLocation</span><span class="p">();</span>
<span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="c1">// 等同于 point.getX();</span>
<span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="c1">// 等同于 point.getY();</span>
</code></pre></div></div>

<p>getCssValue()：返回网页元素指定的CSS属性的值。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">xpath</span><span class="p">(</span><span class="s2">"//div[@id='hplogo']"</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getCssValue</span><span class="p">(</span><span class="s2">"font-size"</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getCssValue</span><span class="p">(</span><span class="s2">"font-weight"</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getCssValue</span><span class="p">(</span><span class="s2">"color"</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getCssValue</span><span class="p">(</span><span class="s2">"background-size"</span><span class="p">));</span>
</code></pre></div></div>

<h3 id="页面跳转的方法">页面跳转的方法</h3>

<p>以下方法用来跳转到某一个页面。</p>

<p>get()：要求浏览器跳到某个网址。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"URL"</span><span class="p">);</span>
</code></pre></div></div>

<p>navigate().back()：浏览器回退。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">navigate</span><span class="p">().</span><span class="nx">back</span><span class="p">();</span>
</code></pre></div></div>

<p>navigate().forward()：浏览器前进。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">navigate</span><span class="p">().</span><span class="nx">forward</span><span class="p">();</span>
</code></pre></div></div>

<p>navigate().to()：跳转到浏览器历史中的某个页面。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">navigate</span><span class="p">().</span><span class="nx">to</span><span class="p">(</span><span class="s2">"URL"</span><span class="p">);</span>
</code></pre></div></div>

<p>navigate().refresh()：刷新当前页面。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">navigate</span><span class="p">().</span><span class="nx">refresh</span><span class="p">();</span>
<span class="c1">// 等同于</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">navigate</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">getCurrentUrl</span><span class="p">());</span>
<span class="c1">// 等同于</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">findElement</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">locatorType</span><span class="p">(</span><span class="s2">"path"</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="nx">Keys</span><span class="p">.</span><span class="nx">F5</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="cookie的方法">cookie的方法</h3>

<p>getCookies()：获取cookie</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nx">getCookies</span><span class="p">();</span>
</code></pre></div></div>

<p>getCookieNamed() ：返回指定名称的cookie。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nx">getCookieNamed</span><span class="p">(</span><span class="s2">"NID"</span><span class="p">));</span>
</code></pre></div></div>

<p>addCookie()：将cookie加入当前页面。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.com"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nx">addCookie</span><span class="p">(</span><span class="nx">cookie0</span><span class="p">);</span>
</code></pre></div></div>

<p>deleteCookie()：删除指定的cookie。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">"https://www.google.co.in"</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nx">deleteCookieNamed</span><span class="p">(</span><span class="s2">"NID"</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="浏览器窗口的方法">浏览器窗口的方法</h3>

<p>maximize()：最大化浏览器窗口。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FirefoxDriver</span><span class="p">();</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">maximize</span><span class="p">();</span>
</code></pre></div></div>

<p>getSize()：返回浏览器窗口、图像、网页元素的宽和高。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">getSize</span><span class="p">();</span>
</code></pre></div></div>

<p>getPosition()：返回浏览器窗口左上角的x坐标和y坐标。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Position X: "</span> <span class="o">+</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">getPosition</span><span class="p">().</span><span class="nx">x</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Position Y: "</span> <span class="o">+</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">getPosition</span><span class="p">().</span><span class="nx">y</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Position X: "</span> <span class="o">+</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">getPosition</span><span class="p">().</span><span class="nx">getX</span><span class="p">());</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Position Y: "</span> <span class="o">+</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">getPosition</span><span class="p">().</span><span class="nx">getY</span><span class="p">());</span>
</code></pre></div></div>

<p>setSize()：定制浏览器窗口的大小。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dimension</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">setSize</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">setSize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Dimension</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">480</span><span class="p">));</span>
</code></pre></div></div>

<p>setPosition()：移动浏览器左上角到指定位置。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">setPosition</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">manage</span><span class="p">().</span><span class="nb">window</span><span class="p">().</span><span class="nx">setPosition</span><span class="p">(</span><span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">150</span><span class="p">));</span>
</code></pre></div></div>

<p>getWindowHandle()：返回当前浏览器窗口。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">parentwindow</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">getWindowHandle</span><span class="p">();</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nb">window</span><span class="p">(</span><span class="nx">parentwindow</span><span class="p">);</span>
</code></pre></div></div>

<p>getWindowHandles()：返回所有浏览器窗口。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">childwindows</span> <span class="o">=</span><span class="err"> </span> <span class="nx">driver</span><span class="p">.</span><span class="nx">getWindowHandles</span><span class="p">();</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nb">window</span><span class="p">(</span><span class="nx">childwindow</span><span class="p">);</span>
</code></pre></div></div>

<p>switchTo.window()：在浏览器窗口之间切换。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">driver</span><span class="p">.</span><span class="nx">SwitchTo</span><span class="p">().</span><span class="nx">Window</span><span class="p">(</span><span class="nx">childwindow</span><span class="p">);</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="nx">driver</span><span class="p">.</span><span class="nx">SwitchTo</span><span class="p">().</span><span class="nx">Window</span><span class="p">(</span><span class="nx">parentWindow</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="弹出窗口">弹出窗口</h3>

<p>以下方法处理浏览器的弹出窗口。</p>

<p>dismiss() ：关闭弹出窗口。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">alert</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nx">alert</span><span class="p">();</span>
<span class="nx">alert</span><span class="p">.</span><span class="nx">dismiss</span><span class="p">();</span>
</code></pre></div></div>

<p>accept()：接受弹出窗口，相当于按下接受OK按钮。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">alert</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nx">alert</span><span class="p">();</span>
<span class="nx">alert</span><span class="p">.</span><span class="nx">accept</span><span class="p">();</span>
</code></pre></div></div>

<p>getText()：返回弹出窗口的文本值。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">alert</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nx">alert</span><span class="p">();</span>
<span class="nx">alert</span><span class="p">.</span><span class="nx">getText</span><span class="p">();</span>
</code></pre></div></div>

<p>sendKeys()：向弹出窗口发送文本字符串。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">alert</span> <span class="o">=</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">switchTo</span><span class="p">().</span><span class="nx">alert</span><span class="p">();</span>
<span class="nx">alert</span><span class="p">.</span><span class="nx">sendKeys</span><span class="p">(</span><span class="s2">"Text to be passed"</span><span class="p">);</span>
</code></pre></div></div>

<p>authenticateUsing()：处理HTTP认证。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserAndPassword</span><span class="p">(</span><span class="s2">"USERNAME"</span><span class="p">,</span> <span class="s2">"PASSWORD"</span><span class="p">);</span>
<span class="nx">alert</span><span class="p">.</span><span class="nx">authenticateUsing</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="鼠标和键盘的方法">鼠标和键盘的方法</h3>

<p>以下方法模拟鼠标和键盘的动作。</p>

<ul>
  <li>click()：鼠标在当前位置点击。</li>
  <li>clickAndHold()：按下鼠标不放</li>
  <li>contextClick()：右击鼠标</li>
  <li>doubleClick()：双击鼠标</li>
  <li>dragAndDrop()：鼠标拖放到目标元素</li>
  <li>dragAndDropBy()：鼠标拖放到目标坐标</li>
  <li>keyDown()：按下某个键</li>
  <li>keyUp()：从按下状态释放某个键</li>
  <li>moveByOffset()：移动鼠标到另一个坐标位置</li>
  <li>moveToElement()：移动鼠标到另一个网页元素</li>
  <li>release()：释放拖拉的元素</li>
  <li>sendKeys()：控制键盘输出</li>
</ul>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li>Jani Hartikainen, <a href="http://www.sitepoint.com/promises-in-javascript-unit-tests-the-definitive-guide/">http://www.sitepoint.com/promises-in-javascript-unit-tests-the-definitive-guide/</a></li>
</ul>


</article>

<div class="row">
<div class="twelve columns">

<h2>留言</h2>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jstutorial'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>

</div>
</div>

<footer>
<div class="row">
<div class="twelve columns">
	<p><a href="/introduction/license.html">版权声明</a> | last modified on 2015-06-08 </p>
</div>
</div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43771063-1', 'ruanyifeng.com');
  ga('send', 'pageview');
</script>
</body>
</html>


