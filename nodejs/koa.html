<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>Koa 框架 -- JavaScript 标准参考教程（alpha）</title>
  
  <!-- Included CSS Files (Uncompressed) -->
  <!--
  <link rel="stylesheet" href="stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="/css/foundation.css">
  <link rel="stylesheet" href="/css/main.css">

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script src="/js/jquery.js"></script>
  <script src="/js/toc.js"></script>
  <script src="/js/main.js"></script>

</head>
<body>

<header class="top-bar" id="header">

<div class="fixed">

<nav class="top-bar">
<ul>
<!-- Title Area -->
	<li class="name has-dropdown">
	<h1><a href="/">JavaScript 标准参考教程（alpha） </a></h1>
		<ul class="dropdown">
			
			<li><a href="/#introduction">导论</a></li>
			
			<li><a href="/#grammar">语法</a></li>
			
			<li><a href="/#stdlib">标准库</a></li>
			
			<li><a href="/#oop">面向对象编程</a></li>
			
			<li><a href="/#advanced">语法专题</a></li>
			
			<li><a href="/#dom">DOM模型</a></li>
			
			<li><a href="/#bom">浏览器环境</a></li>
			
			<li><a href="/#htmlapi">Web API</a></li>
			
		</ul>
	</li>
</ul>

<section>


<ul class="left">
<li class="divider"></li>
<li class="has-dropdown"><a class="active" href="#"> 草稿二：Node.js </a><ul class="dropdown">













<li><a href="/nodejs/assert.html">assert 模块</a></li>













<li><a href="/nodejs/basic.html">Node.js 概述</a></li>













<li><a href="/nodejs/buffer.html">Buffer对象</a></li>





<li><a href="/nodejs/child-process.html">Child Process模块</a></li>





<li><a href="/nodejs/cluster.html">Cluster模块</a></li>

























<li><a href="/nodejs/develop.html">Node应用程序开发</a></li>





<li><a href="/nodejs/dns.html">dns 模块</a></li>





















<li><a href="/nodejs/events.html">Events模块</a></li>







<li><a href="/nodejs/express.html">Express框架</a></li>









<li><a href="/nodejs/fs.html">fs 模块</a></li>



















<li><a href="/nodejs/http.html">Http模块</a></li>



















<li class="active"><a href="#">Koa 框架</a></li>

















<li><a href="/nodejs/module.html">CommonJS规范</a></li>





<li><a href="/nodejs/mongodb.html">MongoDB的应用</a></li>







<li><a href="/nodejs/net.html">Net模块和DNS模块</a></li>









<li><a href="/nodejs/npm.html">npm模块管理器</a></li>

















<li><a href="/nodejs/os.html">os模块</a></li>





<li><a href="/nodejs/packagejson.html">package.json文件</a></li>







<li><a href="/nodejs/path.html">Path模块</a></li>















<li><a href="/nodejs/process.html">process对象</a></li>











<li><a href="/nodejs/querystring.html">querystring 模块</a></li>





















<li><a href="/nodejs/stream.html">Stream接口</a></li>



























<li><a href="/nodejs/url.html">url 模块</a></li>





















</ul></li>
<li class="divider"></li>
<li class="has-dropdown nav-3"><a href="#"> Koa 框架</a><ul class="dropdown">
</ul></li>
</ul>


<ul class="right">
	<li class="divider"></li>
	<li>
		<a href="https://github.com/ruanyf/jstutorial" target="_blank">GitHub <i class="foundicon-edit"></i></a>
	</li>
	<li class="divider"></li>
	<li>
		<a href="#">TOP <i class="foundicon-up-arrow"></i></a>
	</li>
</ul>

</section>

</nav>  
</div>
</header>


<article class="bookPage">

  <div class="row">
    <div class="twelve columns">

<h1> Koa 框架 </h1>

<aside class="right"><p>来自<a href="/">《JavaScript 标准参考教程（alpha）》</a>，by 阮一峰</p></aside>

<div id="toc" class="panel callout radius">目录</div>


<p>Koa是一个类似于Express的Web开发框架，创始人也是同一个人。它的主要特点是，使用了ES6的Generator函数，进行了架构的重新设计。也就是说，Koa的原理和内部结构很像Express，但是语法和内部结构进行了升级。</p>

<p>官方<a href="https://github.com/koajs/koa/blob/master/docs/faq.md#why-isnt-koa-just-express-40">faq</a>有这样一个问题：”为什么koa不是Express 4.0？“，回答是这样的：”Koa与Express有很大差异，整个设计都是不同的，所以如果将Express 3.0按照这种写法升级到4.0，就意味着重写整个程序。所以，我们觉得创造一个新的库，是更合适的做法。“</p>

<h2 id="koa应用">Koa应用</h2>

<p>一个Koa应用就是一个对象，包含了一个middleware数组，这个数组由一组Generator函数组成。这些函数负责对HTTP请求进行各种加工，比如生成缓存、指定代理、请求重定向等等。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'Hello World'</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<p>上面代码中，变量app就是一个Koa应用。它监听3000端口，返回一个内容为Hello World的网页。</p>

<p>app.use方法用于向middleware数组添加Generator函数。</p>

<p>listen方法指定监听端口，并启动当前应用。它实际上等同于下面的代码。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">callback</span><span class="p">()).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="中间件">中间件</h2>

<p>Koa的中间件很像Express的中间件，也是对HTTP请求进行处理的函数，但是必须是一个Generator函数。而且，Koa的中间件是一个级联式（Cascading）的结构，也就是说，属于是层层调用，第一个中间件调用第二个中间件，第二个调用第三个，以此类推。上游的中间件必须等到下游的中间件返回结果，才会继续执行，这点很像递归。</p>

<p>中间件通过当前应用的use方法注册。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">;</span> <span class="c1">// （1）</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>  <span class="c1">// （2）</span>
  <span class="kd">var</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span> <span class="c1">// （3）</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'%s %s - %s'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span> <span class="c1">// （4）</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，<code class="highlighter-rouge">app.use</code>方法的参数就是中间件，它是一个Generator函数，最大的特征就是function命令与参数之间，必须有一个星号。Generator函数的参数next，表示下一个中间件。</p>

<p>Generator函数内部使用yield命令，将程序的执行权转交给下一个中间件，即<code class="highlighter-rouge">yield next</code>，要等到下一个中间件返回结果，才会继续往下执行。上面代码中，Generator函数体内部，第一行赋值语句首先执行，开始计时，第二行yield语句将执行权交给下一个中间件，当前中间件就暂停执行。等到后面的中间件全部执行完成，执行权就回到原来暂停的地方，继续往下执行，这时才会执行第三行，计算这个过程一共花了多少时间，第四行将这个时间打印出来。</p>

<p>下面是一个两个中间件级联的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s2">"header</span><span class="err">\</span><span class="s2">n"</span><span class="p">;</span>
  <span class="k">yield</span> <span class="nx">saveResults</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">+=</span> <span class="s2">"footer</span><span class="err">\</span><span class="s2">n"</span><span class="p">;</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="o">*</span><span class="nx">saveResults</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">+=</span> <span class="s2">"Results Saved!</span><span class="err">\</span><span class="s2">n"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上面代码中，第一个中间件调用第二个中间件saveResults，它们都向<code class="highlighter-rouge">this.body</code>写入内容。最后，<code class="highlighter-rouge">this.body</code>的输出如下。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">header</span>
<span class="nx">Results</span> <span class="nx">Saved</span><span class="o">!</span>
<span class="nx">footer</span>
</code></pre></div></div>

<p>只要有一个中间件缺少<code class="highlighter-rouge">yield next</code>语句，后面的中间件都不会执行，这一点要引起注意。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; one'</span><span class="p">);</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&lt;&lt; one'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; two'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'two'</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&lt;&lt; two'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&gt;&gt; three'</span><span class="p">);</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'&lt;&lt; three'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，因为第二个中间件少了<code class="highlighter-rouge">yield next</code>语句，第三个中间件并不会执行。</p>

<p>如果想跳过一个中间件，可以直接在该中间件的第一行语句写上<code class="highlighter-rouge">return yield next</code>。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">skip</span><span class="p">)</span> <span class="k">return</span> <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
<span class="p">})</span>
</code></pre></div></div>

<p>由于Koa要求中间件唯一的参数就是next，导致如果要传入其他参数，必须另外写一个返回Generator函数的函数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">logger</span><span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">format</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">':method'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">':url'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>

    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="s1">':method :url'</span><span class="p">));</span>
</code></pre></div></div>

<p>上面代码中，真正的中间件是logger函数的返回值，而logger函数是可以接受参数的。</p>

<h3 id="多个中间件的合并">多个中间件的合并</h3>

<p>由于中间件的参数统一为next（意为下一个中间件），因此可以使用<code class="highlighter-rouge">.call(this, next)</code>，将多个中间件进行合并。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="o">*</span><span class="nx">random</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">'/random'</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="o">*</span><span class="nx">backwards</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">'/backwards'</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'sdrawkcab'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="o">*</span><span class="nx">pi</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">'/pi'</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="o">*</span><span class="nx">all</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="nx">random</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">backwards</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">pi</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">next</span><span class="p">)));</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">all</span><span class="p">);</span>
</code></pre></div></div>

<p>上面代码中，中间件all内部，就是依次调用random、backwards、pi，后一个中间件就是前一个中间件的参数。</p>

<p>Koa内部使用koa-compose模块，进行同样的操作，下面是它的源码。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">compose</span><span class="p">(</span><span class="nx">middleware</span><span class="p">){</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">noop</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">next</span> <span class="o">=</span> <span class="nx">middleware</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">yield</span> <span class="o">*</span><span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="o">*</span><span class="nx">noop</span><span class="p">(){}</span>
</code></pre></div></div>

<p>上面代码中，middleware是中间件数组。前一个中间件的参数是后一个中间件，依次类推。如果最后一个中间件没有next参数，则传入一个空函数。</p>

<h2 id="路由">路由</h2>

<p>可以通过<code class="highlighter-rouge">this.path</code>属性，判断用户请求的路径，从而起到路由作用。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'we are at home!'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// 等同于</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">!==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="k">return</span> <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'we are at home!'</span><span class="p">;</span>
<span class="p">})</span>
</code></pre></div></div>

<p>下面是多路径的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">()</span>

<span class="c1">// normal route</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">!==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">yield</span> <span class="nx">next</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'hello world'</span>
<span class="p">});</span>

<span class="c1">// /404 route</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">!==</span> <span class="s1">'/404'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'page not found'</span>
<span class="p">});</span>

<span class="c1">// /500 route</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">!==</span> <span class="s1">'/500'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'internal server error'</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div></div>

<p>上面代码中，每一个中间件负责一个路径，如果路径不符合，就传递给下一个中间件。</p>

<p>复杂的路由需要安装koa-router插件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">)();</span>
<span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-router'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">myRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>

<span class="nx">myRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'Hello World!'</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">myRouter</span><span class="p">.</span><span class="nx">routes</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<p>上面代码对根路径设置路由。</p>

<p>Koa-router实例提供一系列动词方法，即一种HTTP动词对应一种方法。典型的动词方法有以下五种。</p>

<ul>
  <li>router.get()</li>
  <li>router.post()</li>
  <li>router.put()</li>
  <li>router.del()</li>
  <li>router.patch()</li>
</ul>

<p>这些动词方法可以接受两个参数，第一个是路径模式，第二个是对应的控制器方法（中间件），定义用户请求该路径时服务器行为。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'Hello World!'</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，<code class="highlighter-rouge">router.get</code>方法的第一个参数是根路径，第二个参数是对应的函数方法。</p>

<p>注意，路径匹配的时候，不会把查询字符串考虑在内。比如，<code class="highlighter-rouge">/index?param=xyz</code>匹配路径<code class="highlighter-rouge">/index</code>。</p>

<p>有些路径模式比较复杂，Koa-router允许为路径模式起别名。起名时，别名要添加为动词方法的第一个参数，这时动词方法变成接受三个参数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">'/users/:id'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，路径模式<code class="highlighter-rouge">\users\:id</code>的名字就是<code class="highlighter-rouge">user</code>。路径的名称，可以用来引用对应的具体路径，比如url方法可以根据路径名称，结合给定的参数，生成具体的路径。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="c1">// =&gt; "/users/3"</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">3</span> <span class="p">});</span>
<span class="c1">// =&gt; "/users/3"</span>
</code></pre></div></div>

<p>上面代码中，user就是路径模式的名称，对应具体路径<code class="highlighter-rouge">/users/:id</code>。url方法的第二个参数3，表示给定id的值是3，因此最后生成的路径是<code class="highlighter-rouge">/users/3</code>。</p>

<p>Koa-router允许为路径统一添加前缀。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
  <span class="na">prefix</span><span class="p">:</span> <span class="s1">'/users'</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// 等同于"/users"</span>
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// 等同于"/users/:id"</span>
</code></pre></div></div>

<p>路径的参数通过<code class="highlighter-rouge">this.params</code>属性获取，该属性返回一个对象，所有路径参数都是该对象的成员。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 访问 /programming/how-to-node</span>
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/:category/:title'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
  <span class="c1">// =&gt; { category: 'programming', title: 'how-to-node' }</span>
<span class="p">});</span>
</code></pre></div></div>

<p>param方法可以针对命名参数，设置验证条件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/users/:user'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">'0号用户'</span><span class="p">,</span> <span class="s1">'1号用户'</span><span class="p">,</span> <span class="s1">'2号用户'</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">users</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>上面代码中，如果<code class="highlighter-rouge">/users/:user</code>的参数user对应的不是有效用户（比如访问<code class="highlighter-rouge">/users/3</code>），param方法注册的中间件会查到，就会返回404错误。</p>

<p>redirect方法会将某个路径的请求，重定向到另一个路径，并返回301状态码。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="s1">'sign-in'</span><span class="p">);</span>

<span class="c1">// 等同于</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/sign-in'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>redirect方法的第一个参数是请求来源，第二个参数是目的地，两者都可以用路径模式的别名代替。</p>

<h2 id="context对象">context对象</h2>

<p>中间件当中的this表示上下文对象context，代表一次HTTP请求和回应，即一次访问/回应的所有信息，都可以从上下文对象获得。context对象封装了request和response对象，并且提供了一些辅助方法。每次HTTP请求，就会创建一个新的context对象。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
  <span class="k">this</span><span class="p">;</span> <span class="c1">// is the Context</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span> <span class="c1">// is a koa Request</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span> <span class="c1">// is a koa Response</span>
<span class="p">});</span>
</code></pre></div></div>

<p>context对象的很多方法，其实是定义在ctx.request对象或ctx.response对象上面，比如，ctx.type和ctx.length对应于ctx.response.type和ctx.response.length，ctx.path和ctx.method对应于ctx.request.path和ctx.request.method。</p>

<p>context对象的全局属性。</p>

<ul>
  <li>request：指向Request对象</li>
  <li>response：指向Response对象</li>
  <li>req：指向Node的request对象</li>
  <li>res：指向Node的response对象</li>
  <li>app：指向App对象</li>
  <li>state：用于在中间件传递信息。</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</code></pre></div></div>

<p>上面代码中，user属性存放在<code class="highlighter-rouge">this.state</code>对象上面，可以被另一个中间件读取。</p>

<p>context对象的全局方法。</p>

<ul>
  <li>throw()：抛出错误，直接决定了HTTP回应的状态码。</li>
  <li>assert()：如果一个表达式为false，则抛出一个错误。</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'name required'</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'something exploded'</span><span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">'name required'</span><span class="p">);</span>
<span class="c1">// 等同于</span>
<span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'name required'</span><span class="p">);</span>
<span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
<span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
</code></pre></div></div>

<p>assert方法的例子。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 格式</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="p">[</span><span class="nx">msg</span><span class="p">],</span> <span class="p">[</span><span class="nx">status</span><span class="p">],</span> <span class="p">[</span><span class="nx">properties</span><span class="p">])</span>

<span class="c1">// 例子</span>
<span class="k">this</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'User not found. Please login!'</span><span class="p">);</span>
</code></pre></div></div>

<p>以下模块解析POST请求的数据。</p>

<ul>
  <li>co-body</li>
  <li>https://github.com/koajs/body-parser</li>
  <li>https://github.com/koajs/body-parsers</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'co-body'</span><span class="p">);</span>

<span class="c1">// in Koa handler</span>
<span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="错误处理机制">错误处理机制</h2>

<p>Koa提供内置的错误处理机制，任何中间件抛出的错误都会被捕捉到，引发向客户端返回一个500错误，而不会导致进程停止，因此也就不需要forever这样的模块重启进程。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码中，中间件内部抛出一个错误，并不会导致Koa应用挂掉。Koa内置的错误处理机制，会捕捉到这个错误。</p>

<p>当然，也可以额外部署自己的错误处理机制。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">saveResults</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">'数据无效'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码自行部署了try…catch代码块，一旦产生错误，就用<code class="highlighter-rouge">this.throw</code>方法抛出。该方法可以将指定的状态码和错误信息，返回给客户端。</p>

<p>对于未捕获错误，可以设置error事件的监听函数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'server error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>error事件的监听函数还可以接受上下文对象，作为第二个参数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">){</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'server error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>如果一个错误没有被捕获，koa会向客户端返回一个500错误“Internal Server Error”。</p>

<p>this.throw方法用于向客户端抛出一个错误。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'name required'</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">'name required'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'something exploded'</span><span class="p">);</span>

<span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="s1">'name required'</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="c1">// 等同于</span>
<span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'name required'</span><span class="p">);</span>
<span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
<span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">this.throw</code>方法的两个参数，一个是错误码，另一个是报错信息。如果省略状态码，默认是500错误。</p>

<p><code class="highlighter-rouge">this.assert</code>方法用于在中间件之中断言，用法类似于Node的assert模块。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'User not found. Please login!'</span><span class="p">);</span>
</code></pre></div></div>

<p>上面代码中，如果this.user属性不存在，会抛出一个401错误。</p>

<p>由于中间件是层级式调用，所以可以把<code class="highlighter-rouge">try { yield next }</code>当成第一个中间件。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'some error'</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="cookie">cookie</h2>

<p>cookie的读取和设置。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'view'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'view'</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
</code></pre></div></div>

<p>get和set方法都可以接受第三个参数，表示配置参数。其中的signed参数，用于指定cookie是否加密。如果指定加密的话，必须用<code class="highlighter-rouge">app.keys</code>指定加密短语。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'secret1'</span><span class="p">,</span> <span class="s1">'secret2'</span><span class="p">];</span>
<span class="k">this</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'张三'</span><span class="p">,</span> <span class="p">{</span> <span class="na">signed</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
</code></pre></div></div>

<p>this.cookie的配置对象的属性如下。</p>

<ul>
  <li>signed：cookie是否加密。</li>
  <li>expires：cookie何时过期</li>
  <li>path：cookie的路径，默认是“/”。</li>
  <li>domain：cookie的域名。</li>
  <li>secure：cookie是否只有https请求下才发送。</li>
  <li>httpOnly：是否只有服务器可以取到cookie，默认为true。</li>
</ul>

<h2 id="session">session</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-session'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'some secret hurr'</span><span class="p">];</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">(</span><span class="nx">app</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">views</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="o">++</span><span class="nx">n</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">' views'</span><span class="p">;</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'listening on port 3000'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="request对象">Request对象</h2>

<p>Request对象表示HTTP请求。</p>

<p>（1）this.request.header</p>

<p>返回一个对象，包含所有HTTP请求的头信息。它也可以写成<code class="highlighter-rouge">this.request.headers</code>。</p>

<p>（2）this.request.method</p>

<p>返回HTTP请求的方法，该属性可读写。</p>

<p>（3）this.request.length</p>

<p>返回HTTP请求的Content-Length属性，取不到值，则返回undefined。</p>

<p>（4）this.request.path</p>

<p>返回HTTP请求的路径，该属性可读写。</p>

<p>（5）this.request.href</p>

<p>返回HTTP请求的完整路径，包括协议、端口和url。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">href</span>
<span class="c1">// http://example.com/foo/bar?q=1</span>
</code></pre></div></div>

<p>（6）this.request.querystring</p>

<p>返回HTTP请求的查询字符串，不含问号。该属性可读写。</p>

<p>（7）this.request.search</p>

<p>返回HTTP请求的查询字符串，含问号。该属性可读写。</p>

<p>（8）this.request.host</p>

<p>返回HTTP请求的主机（含端口号）。</p>

<p>（9）this.request.hostname</p>

<p>返回HTTP的主机名（不含端口号）。</p>

<p>（10）this.request.type</p>

<p>返回HTTP请求的Content-Type属性。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ct</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
<span class="c1">// "image/png"</span>
</code></pre></div></div>

<p>（11）this.request.charset</p>

<p>返回HTTP请求的字符集。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">charset</span>
<span class="c1">// "utf-8"</span>
</code></pre></div></div>

<p>（12）this.request.query</p>

<p>返回一个对象，包含了HTTP请求的查询字符串。如果没有查询字符串，则返回一个空对象。该属性可读写。</p>

<p>比如，查询字符串<code class="highlighter-rouge">color=blue&amp;size=small</code>，会得到以下的对象。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="s1">'blue'</span><span class="p">,</span>
  <span class="nx">size</span><span class="p">:</span> <span class="s1">'small'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>（13）this.request.fresh</p>

<p>返回一个布尔值，表示缓存是否代表了最新内容。通常与If-None-Match、ETag、If-Modified-Since、Last-Modified等缓存头，配合使用。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'ETag'</span><span class="p">,</span> <span class="s1">'123'</span><span class="p">);</span>

<span class="c1">// 检查客户端请求的内容是否有变化</span>
<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">fresh</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">304</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 否则就表示客户端的内容陈旧了，</span>
<span class="c1">// 需要取出新内容</span>
<span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">db</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'something'</span><span class="p">);</span>
</code></pre></div></div>

<p>（14）this.request.stale</p>

<p>返回<code class="highlighter-rouge">this.request.fresh</code>的相反值。</p>

<p>（15）this.request.protocol</p>

<p>返回HTTP请求的协议，https或者http。</p>

<p>（16）this.request.secure</p>

<p>返回一个布尔值，表示当前协议是否为https。</p>

<p>（17）this.request.ip</p>

<p>返回发出HTTP请求的IP地址。</p>

<p>（18）this.request.subdomains</p>

<p>返回一个数组，表示HTTP请求的子域名。该属性必须与app.subdomainOffset属性搭配使用。app.subdomainOffset属性默认为2，则域名“tobi.ferrets.example.com”返回[“ferrets”, “tobi”]，如果app.subdomainOffset设为3，则返回[“tobi”]。</p>

<p>（19）this.request.is(types…)</p>

<p>返回指定的类型字符串，表示HTTP请求的Content-Type属性是否为指定类型。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Content-Type为 text/html; charset=utf-8</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'html'</span><span class="p">);</span> <span class="c1">// 'html'</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'text/html'</span><span class="p">);</span> <span class="c1">// 'text/html'</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'text/*'</span><span class="p">,</span> <span class="s1">'text/html'</span><span class="p">);</span> <span class="c1">// 'text/html'</span>

<span class="c1">// Content-Type为 application/json</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'json'</span><span class="p">,</span> <span class="s1">'urlencoded'</span><span class="p">);</span> <span class="c1">// 'json'</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'application/json'</span><span class="p">);</span> <span class="c1">// 'application/json'</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'html'</span><span class="p">,</span> <span class="s1">'application/*'</span><span class="p">);</span> <span class="c1">// 'application/json'</span>
</code></pre></div></div>

<p>如果不满足条件，返回false；如果HTTP请求不含数据，则返回undefined。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'html'</span><span class="p">);</span> <span class="c1">// false</span>
</code></pre></div></div>

<p>它可以用于过滤HTTP请求，比如只允许请求下载图片。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'image/*'</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// process</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">415</span><span class="p">,</span> <span class="s1">'images only!'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>（20）this.request.accepts(types)</p>

<p>检查HTTP请求的Accept属性是否可接受，如果可接受，则返回指定的媒体类型，否则返回false。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept: text/html</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'html'</span><span class="p">);</span>
<span class="c1">// "html"</span>

<span class="c1">// Accept: text/*, application/json</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'html'</span><span class="p">);</span>
<span class="c1">// "html"</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'text/html'</span><span class="p">);</span>
<span class="c1">// "text/html"</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'json'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">);</span>
<span class="c1">// =&gt; "json"</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'application/json'</span><span class="p">);</span>
<span class="c1">// =&gt; "application/json"</span>

<span class="c1">// Accept: text/*, application/json</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'image/png'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'png'</span><span class="p">);</span>
<span class="c1">// false</span>

<span class="c1">// Accept: text/*;q=.5, application/json</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">([</span><span class="s1">'html'</span><span class="p">,</span> <span class="s1">'json'</span><span class="p">]);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'html'</span><span class="p">,</span> <span class="s1">'json'</span><span class="p">);</span>
<span class="c1">// "json"</span>

<span class="c1">// No Accept header</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'html'</span><span class="p">,</span> <span class="s1">'json'</span><span class="p">);</span>
<span class="c1">// "html"</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'json'</span><span class="p">,</span> <span class="s1">'html'</span><span class="p">);</span>
<span class="c1">// =&gt; "json"</span>
</code></pre></div></div>

<p>如果accepts方法没有参数，则返回所有支持的类型（text/html,application/xhtml+xml,image/webp,application/xml,<em>/</em>）。</p>

<p>如果accepts方法的参数有多个参数，则返回最佳匹配。如果都不匹配则返回false，并向客户端抛出一个406”Not Acceptable“错误。</p>

<p>如果HTTP请求没有Accept字段，那么accepts方法返回它的第一个参数。</p>

<p>accepts方法可以根据不同Accept字段，向客户端返回不同的字段。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="s1">'json'</span><span class="p">,</span> <span class="s1">'html'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">'json'</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="s1">'html'</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="s1">'text'</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
  <span class="nl">default</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">406</span><span class="p">,</span> <span class="s1">'json, html, or text only'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>（21）this.request.acceptsEncodings(encodings)</p>

<p>该方法根据HTTP请求的Accept-Encoding字段，返回最佳匹配，如果没有合适的匹配，则返回false。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept-Encoding: gzip</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsEncodings</span><span class="p">(</span><span class="s1">'gzip'</span><span class="p">,</span> <span class="s1">'deflate'</span><span class="p">,</span> <span class="s1">'identity'</span><span class="p">);</span>
<span class="c1">// "gzip"</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsEncodings</span><span class="p">([</span><span class="s1">'gzip'</span><span class="p">,</span> <span class="s1">'deflate'</span><span class="p">,</span> <span class="s1">'identity'</span><span class="p">]);</span>
<span class="c1">// "gzip"</span>
</code></pre></div></div>

<p>注意，acceptEncodings方法的参数必须包括identity（意为不编码）。</p>

<p>如果HTTP请求没有Accept-Encoding字段，acceptEncodings方法返回所有可以提供的编码方法。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept-Encoding: gzip, deflate</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsEncodings</span><span class="p">();</span>
<span class="c1">// ["gzip", "deflate", "identity"]</span>
</code></pre></div></div>

<p>如果都不匹配，acceptsEncodings方法返回false，并向客户端抛出一个406“Not Acceptable”错误。</p>

<p>（22）this.request.acceptsCharsets(charsets)</p>

<p>该方法根据HTTP请求的Accept-Charset字段，返回最佳匹配，如果没有合适的匹配，则返回false。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept-Charset: utf-8, iso-8859-1;q=0.2, utf-7;q=0.5</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsCharsets</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="s1">'utf-7'</span><span class="p">);</span>
<span class="c1">// =&gt; "utf-8"</span>

<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsCharsets</span><span class="p">([</span><span class="s1">'utf-7'</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">]);</span>
<span class="c1">// =&gt; "utf-8"</span>
</code></pre></div></div>

<p>如果acceptsCharsets方法没有参数，则返回所有可接受的匹配。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept-Charset: utf-8, iso-8859-1;q=0.2, utf-7;q=0.5</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsCharsets</span><span class="p">();</span>
<span class="c1">// ["utf-8", "utf-7", "iso-8859-1"]</span>
</code></pre></div></div>

<p>如果都不匹配，acceptsCharsets方法返回false，并向客户端抛出一个406“Not Acceptable”错误。</p>

<p>（23）this.request.acceptsLanguages(langs)</p>

<p>该方法根据HTTP请求的Accept-Language字段，返回最佳匹配，如果没有合适的匹配，则返回false。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept-Language: en;q=0.8, es, pt</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsLanguages</span><span class="p">(</span><span class="s1">'es'</span><span class="p">,</span> <span class="s1">'en'</span><span class="p">);</span>
<span class="c1">// "es"</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsLanguages</span><span class="p">([</span><span class="s1">'en'</span><span class="p">,</span> <span class="s1">'es'</span><span class="p">]);</span>
<span class="c1">// "es"</span>
</code></pre></div></div>

<p>如果acceptsCharsets方法没有参数，则返回所有可接受的匹配。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept-Language: en;q=0.8, es, pt</span>
<span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">acceptsLanguages</span><span class="p">();</span>
<span class="c1">// ["es", "pt", "en"]</span>
</code></pre></div></div>

<p>如果都不匹配，acceptsLanguages方法返回false，并向客户端抛出一个406“Not Acceptable”错误。</p>

<p>（24）this.request.socket</p>

<p>返回HTTP请求的socket。</p>

<p>（25）this.request.get(field)</p>

<p>返回HTTP请求指定的字段。</p>

<h2 id="response对象">Response对象</h2>

<p>Response对象表示HTTP回应。</p>

<p>（1）this.response.header</p>

<p>返回HTTP回应的头信息。</p>

<p>（2）this.response.socket</p>

<p>返回HTTP回应的socket。</p>

<p>（3）this.response.status</p>

<p>返回HTTP回应的状态码。默认情况下，该属性没有值。该属性可读写，设置时等于一个整数。</p>

<p>（4）this.response.message</p>

<p>返回HTTP回应的状态信息。该属性与<code class="highlighter-rouge">this.response.message</code>是配对的。该属性可读写。</p>

<p>（5）this.response.length</p>

<p>返回HTTP回应的Content-Length字段。该属性可读写，如果没有设置它的值，koa会自动从this.request.body推断。</p>

<p>（6）this.response.body</p>

<p>返回HTTP回应的信息体。该属性可读写，它的值可能有以下几种类型。</p>

<ul>
  <li>字符串：Content-Type字段默认为text/html或text/plain，字符集默认为utf-8，Content-Length字段同时设定。</li>
  <li>二进制Buffer：Content-Type字段默认为application/octet-stream，Content-Length字段同时设定。</li>
  <li>Stream：Content-Type字段默认为application/octet-stream。</li>
  <li>JSON对象：Content-Type字段默认为application/json。</li>
  <li>null（表示没有信息体）</li>
</ul>

<p>如果<code class="highlighter-rouge">this.response.status</code>没设置，Koa会自动将其设为200或204。</p>

<p>（7）this.response.get(field)</p>

<p>返回HTTP回应的指定字段。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">etag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'ETag'</span><span class="p">);</span>
</code></pre></div></div>

<p>注意，get方法的参数是区分大小写的。</p>

<p>（8）this.response.set()</p>

<p>设置HTTP回应的指定字段。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'Cache-Control'</span><span class="p">,</span> <span class="s1">'no-cache'</span><span class="p">);</span>
</code></pre></div></div>

<p>set方法也可以接受一个对象作为参数，同时为多个字段指定值。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="kd">set</span><span class="p">({</span>
  <span class="s1">'Etag'</span><span class="p">:</span> <span class="s1">'1234'</span><span class="p">,</span>
  <span class="s1">'Last-Modified'</span><span class="p">:</span> <span class="nx">date</span>
<span class="p">});</span>
</code></pre></div></div>

<p>（9）this.response.remove(field)</p>

<p>移除HTTP回应的指定字段。</p>

<p>（10）this.response.type</p>

<p>返回HTTP回应的Content-Type字段，不包括“charset”参数的部分。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ct</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reponse</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
<span class="c1">// "image/png"</span>
</code></pre></div></div>

<p>该属性是可写的。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">reponse</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'text/plain; charset=utf-8'</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">reponse</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'image/png'</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">reponse</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'.png'</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">reponse</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'png'</span><span class="p">;</span>
</code></pre></div></div>

<p>设置type属性的时候，如果没有提供charset参数，Koa会判断是否自动设置。如果<code class="highlighter-rouge">this.response.type</code>设为html，charset默认设为utf-8；但如果<code class="highlighter-rouge">this.response.type</code>设为text/html，就不会提供charset的默认值。</p>

<p>（10）this.response.is(types…)</p>

<p>该方法类似于<code class="highlighter-rouge">this.request.is()</code>，用于检查HTTP回应的类型是否为支持的类型。</p>

<p>它可以在中间件中起到处理不同格式内容的作用。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">minify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'html-minifier'</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="o">*</span><span class="nx">minifyHTML</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
  <span class="k">yield</span> <span class="nx">next</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">'html'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span> <span class="o">||</span> <span class="nx">body</span><span class="p">.</span><span class="nx">pipe</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">minify</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>上面代码是一个中间件，如果输出的内容类型为HTML，就会进行最小化处理。</p>

<p>（11）this.response.redirect(url, [alt])</p>

<p>该方法执行302跳转到指定网址。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'back'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'back'</span><span class="p">,</span> <span class="s1">'/index.html'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'http://google.com'</span><span class="p">);</span>
</code></pre></div></div>

<p>如果redirect方法的第一个参数是back，将重定向到HTTP请求的Referrer字段指定的网址，如果没有该字段，则重定向到第二个参数或“/”网址。</p>

<p>如果想修改302状态码，或者修改body文字，可以采用下面的写法。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">301</span><span class="p">;</span>
<span class="k">this</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/cart'</span><span class="p">);</span>
<span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">'Redirecting to shopping cart'</span><span class="p">;</span>
</code></pre></div></div>

<p>（12）this.response.attachment([filename])</p>

<p>该方法将HTTP回应的Content-Disposition字段，设为“attachment”，提示浏览器下载指定文件。</p>

<p>（13）this.response.headerSent</p>

<p>该方法返回一个布尔值，检查是否HTTP回应已经发出。</p>

<p>（14）this.response.lastModified</p>

<p>该属性以Date对象的形式，返回HTTP回应的Last-Modified字段（如果该字段存在）。该属性可写。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">lastModified</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</code></pre></div></div>

<p>（15）this.response.etag</p>

<p>该属性设置HTTP回应的ETag字段。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">etag</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">'md5'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
</code></pre></div></div>

<p>注意，不能用该属性读取ETag字段。</p>

<p>（16）this.response.vary(field)</p>

<p>该方法将参数添加到HTTP回应的Vary字段。</p>

<h2 id="csrf攻击">CSRF攻击</h2>

<p>CSRF攻击是指用户的session被劫持，用来冒充用户的攻击。</p>

<p>koa-csrf插件用来防止CSRF攻击。原理是在session之中写入一个秘密的token，用户每次使用POST方法提交数据的时候，必须含有这个token，否则就会抛出错误。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-session'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">csrf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-csrf'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">route</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-route'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">koa</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'session key'</span><span class="p">,</span> <span class="s1">'csrf example'</span><span class="p">];</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">(</span><span class="nx">app</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">csrf</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/token'</span><span class="p">,</span> <span class="nx">token</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/post'</span><span class="p">,</span> <span class="nx">post</span><span class="p">));</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">token</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">csrf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">post</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="p">{</span><span class="na">ok</span><span class="p">:</span> <span class="kc">true</span><span class="p">};</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<p>POST请求含有token，可以是以下几种方式之一，koa-csrf插件就能获得token。</p>

<ul>
  <li>表单的_csrf字段</li>
  <li>查询字符串的_csrf字段</li>
  <li>HTTP请求头信息的x-csrf-token字段</li>
  <li>HTTP请求头信息的x-xsrf-token字段</li>
</ul>

<h2 id="数据压缩">数据压缩</h2>

<p>koa-compress模块可以实现数据压缩。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">'koa-compress'</span><span class="p">)())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'text/plain'</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">'filename.txt'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="源码解读">源码解读</h2>

<p>每一个网站就是一个app，它由<code class="highlighter-rouge">lib/application</code>定义。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Application</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Application</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">env</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">||</span> <span class="s1">'development'</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subdomainOffset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">middleware</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">Application</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

<span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Application</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">app.use()</code>用于注册中间件，即将Generator函数放入中间件数组。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">experimental</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// es7 async functions are allowed</span>
    <span class="nx">assert</span><span class="p">(</span><span class="nx">fn</span> <span class="o">&amp;&amp;</span> <span class="s1">'GeneratorFunction'</span> <span class="o">==</span> <span class="nx">fn</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">'app.use() requires a generator function'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">'use %s'</span><span class="p">,</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">_name</span> <span class="o">||</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">'-'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">app.listen()</code>就是<code class="highlighter-rouge">http.createServer(app.callback()).listen(...)</code>的缩写。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">debug</span><span class="p">(</span><span class="s1">'listen'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">());</span>
  <span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="kr">arguments</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">mw</span> <span class="o">=</span> <span class="p">[</span><span class="nx">respond</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">middleware</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">experimental</span>
    <span class="p">?</span> <span class="nx">compose_es7</span><span class="p">(</span><span class="nx">mw</span><span class="p">)</span>
    <span class="p">:</span> <span class="nx">co</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">compose</span><span class="p">(</span><span class="nx">mw</span><span class="p">));</span>
  <span class="kd">var</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="s1">'error'</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onerror</span><span class="p">);</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">onFinished</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">onerror</span><span class="p">);</span>
    <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">onerror</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>上面代码中，<code class="highlighter-rouge">app.callback()</code>会返回一个函数，用来处理HTTP请求。它的第一行<code class="highlighter-rouge">mw = [respond].concat(this.middleware)</code>，表示将respond函数（这也是一个Generator函数）放入<code class="highlighter-rouge">this.middleware</code>，现在mw就变成了<code class="highlighter-rouge">[respond, S1, S2, S3]</code>。</p>

<p><code class="highlighter-rouge">compose(mw)</code>将中间件数组转为一个层层调用的Generator函数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">compose</span><span class="p">(</span><span class="nx">middleware</span><span class="p">){</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="o">*</span><span class="p">(</span><span class="nx">next</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">next</span><span class="p">)</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">noop</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">next</span> <span class="o">=</span> <span class="nx">middleware</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">yield</span> <span class="o">*</span><span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="o">*</span><span class="nx">noop</span><span class="p">(){}</span>
</code></pre></div></div>

<p>上面代码中，下一个generator函数总是上一个Generator函数的参数，从而保证了层层调用。</p>

<p><code class="highlighter-rouge">var fn = co.wrap(gen)</code>则是将Generator函数包装成一个自动执行的函数，并且返回一个Promise。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//co package</span>
<span class="nx">co</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">co</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kr">arguments</span><span class="p">));</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>

<p>由于<code class="highlighter-rouge">co.wrap(compose(mw))</code>执行后，返回的是一个Promise，所以可以对其使用catch方法指定捕捉错误的回调函数<code class="highlighter-rouge">fn.call(ctx).catch(ctx.onerror)</code>。</p>

<p>将所有的上下文变量都放进context对象。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">createContext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onerror</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">originalUrl</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">originalUrl</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">cookies</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cookies</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">);</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">accept</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">accept</span> <span class="o">=</span> <span class="nx">accepts</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>真正处理HTTP请求的是下面这个Generator函数。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="o">*</span><span class="nx">respond</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="o">*</span><span class="nx">next</span><span class="p">;</span>

  <span class="c1">// allow bypassing koa</span>
  <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">respond</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">res</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">headersSent</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>

  <span class="c1">// ignore body</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">statuses</span><span class="p">.</span><span class="nx">empty</span><span class="p">[</span><span class="nx">code</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// strip headers</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">'HEAD'</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isJSON</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// status body</span>
  <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'text'</span><span class="p">;</span>
    <span class="nx">body</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nb">String</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// responses</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="s1">'string'</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">body</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span> <span class="k">instanceof</span> <span class="nx">Stream</span><span class="p">)</span> <span class="k">return</span> <span class="nx">body</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>

  <span class="c1">// body: json</span>
  <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li><a href="https://github.com/koajs/koa/blob/master/docs/guide.md">Koa Guide</a></li>
  <li>William XING, <a href="http://william.xingyp.com/is-koa-js-right-for-me/">Is Koa.js right for me?</a></li>
</ul>


</article>

<div class="row">
<div class="twelve columns">

<h2>留言</h2>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jstutorial'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>

</div>
</div>

<footer>
<div class="row">
<div class="twelve columns">
	<p><a href="/introduction/license.html">版权声明</a> | last modified on 2015-04-17 </p>
</div>
</div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43771063-1', 'ruanyifeng.com');
  ga('send', 'pageview');
</script>
</body>
</html>


